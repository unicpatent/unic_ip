<%- include('partials/header', {title: 'ë“±ë¡íŠ¹í—ˆ ì¡°íšŒ'}) %>

<main class="main-content">
    <div class="container">
        <div class="page-title">
            <h1>ë“±ë¡íŠ¹í—ˆ ì¡°íšŒ</h1>
            <p>ê³ ê°ë²ˆí˜¸ë¡œ KIPRISì—ì„œ ì§ì ‘ ê²€ìƒ‰í•˜ì—¬ ë“±ë¡íŠ¹í—ˆë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤</p>
        </div>

        <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <!-- ê³ ê°ë²ˆí˜¸ ì…ë ¥ í•„ë“œ -->
                <div class="form-group">
                    <label for="customerNumber" class="form-label">ê³ ê°ë²ˆí˜¸</label>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="customerNumber" 
                            name="customerNumber" 
                            class="form-input customer-number-input"
                            placeholder="ì˜ˆ: 120190612244"
                            maxlength="12"
                            pattern="[0-9]{12}"
                        >
                        <button type="submit" class="btn btn-primary" id="searchBtn">
                            ğŸ” KIPRIS ê²€ìƒ‰
                        </button>
                    </div>
                    <div class="form-hint">12ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš” (KIPRISì—ì„œ ì§ì ‘ í¬ë¡¤ë§í•©ë‹ˆë‹¤)</div>
                </div>

                <button type="button" class="btn btn-secondary find-customer-btn" id="findCustomerBtn">
                    ê³ ê°ë²ˆí˜¸ ì°¾ê¸°
                </button>
            </form>
        </section>

        <!-- ê²€ìƒ‰ ìƒíƒœ í‘œì‹œ -->
        <section class="search-status" id="searchStatus" style="display: none;">
            <div class="status-content">
                <div class="loading-spinner"></div>
                <div class="status-message" id="statusMessage">KIPRIS ì‚¬ì´íŠ¸ì— ì ‘ì† ì¤‘...</div>
                <div class="status-details" id="statusDetails"></div>
            </div>
        </section>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <section class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-info">
                    <div class="info-item">
                        <span class="info-label">ì¡°íšŒì¼ì:</span>
                        <span class="info-value" id="resultCurrentDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ê³ ê°ë²ˆí˜¸:</span>
                        <span class="info-value" id="resultCustomerNumber">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ê²€ìƒ‰ë°©ë²•:</span>
                        <span class="info-value">KIPRIS í¬ë¡¤ë§</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ë°œê²¬ëœ ì¶œì›ë²ˆí˜¸:</span>
                        <span class="info-value" id="resultTotalCount">0</span>ê±´
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-info" id="calculateAnnuityBtn">
                        ğŸ§® ì—°ì°¨ë£Œ ê³„ì‚°
                    </button>
                    <button type="button" class="btn btn-success" id="viewAnnuityBtn">
                        ğŸ“‹ ì—°ì°¨ë£Œ ì¡°íšŒ
                    </button>
                    <button type="button" class="btn btn-primary" id="renewalRequestBtn">
                        ğŸ’° ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢°
                    </button>
                    <button type="button" class="btn btn-secondary" id="exportBtn">
                        ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="patent-table" id="patentTable">
                    <thead>
                        <tr>
                            <th>ì¶œì›ë²ˆí˜¸</th>
                            <th>ë“±ë¡ë²ˆí˜¸</th>
                            <th>ì¶œì›ì¸</th>
                            <th>ì¶œì›ì¼</th>
                            <th>ë“±ë¡ì¼</th>
                            <th>ì¡´ì†ê¸°ê°„ ë§Œë£Œì¼</th>
                            <th>ë°œëª…ì˜ëª…ì¹­</th>
                            <th>ì²­êµ¬í•­ìˆ˜</th>
                            <th>ì§ì „ë…„ë„ ë‚©ë¶€ì—°ì›”</th>
                            <th>í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼</th>
                            <th>í•´ë‹¹ì—°ì°¨ìˆ˜</th>
                            <th>í•´ë‹¹ì—°ì°¨ë£Œ</th>
                            <th>ìœ íš¨/ë¶ˆë‚©</th>
                            <th>ì •ìƒë‚©ë¶€/ë¯¸ë‚©</th>
                            <th>ì¶”ë‚©ê¸°ê°„</th>
                            <th>íšŒë³µê¸°ê°„</th>
                        </tr>
                    </thead>
                    <tbody id="patentTableBody">
                        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“„</div>
                <div class="empty-title">ë“±ë¡íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="empty-description">í•´ë‹¹ ê³ ê°ë²ˆí˜¸ë¡œ ë“±ë¡ëœ íŠ¹í—ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </section>
    </div>
</main>

<%- include('partials/footer') %>

<script>
// ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ë²„ì „ ì²´í¬
console.log('ğŸ”„ ë“±ë¡íŠ¹í—ˆ ì¡°íšŒ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨ - ë²„ì „: 2025.09.06.v1');
</script>

<!-- ë“±ë¡íŠ¹í—ˆ ì¡°íšŒ ê¸°ëŠ¥ (í¬ë¡¤ë§ ê¸°ë°˜) -->
<script src="/js/patent-search.js?v=2025.09.06.v1"></script>

<script>
// ì—°ì°¨ë£Œ ê³„ì‚° ê´€ë ¨ ìƒìˆ˜ë“¤ê³¼ í•¨ìˆ˜ë“¤ (registered.ejsì™€ ë™ì¼)
// ì—°ì°¨ë£Œ ê³„ì‚° ì •ì±… (annuity.txtì—ì„œ ê°€ì ¸ì˜¨ ì •ì±…)
const ANNUITY_POLICY = {
    "name": "KIPO-default",
    "currency": "KRW",
    "grace_months": 6,
    "recovery_months": 3,
    "late_fee_table": {
        "1": 0.03,
        "2": 0.06,
        "3": 0.09,
        "4": 0.12,
        "5": 0.15,
        "6": 0.18
    },
    "recovery_policy": { "type": "multiplier", "value": 2.0 },
    "rounding": "nearest_10",
    "reminder_rules": [
        { "months_before_due": 6, "label": "ì‚¬ì „ì˜ˆê³ -6ê°œì›”" },
        { "months_before_due": 3, "label": "ì‚¬ì „ì˜ˆê³ -3ê°œì›”" },
        { "months_before_due": 1, "label": "ì‚¬ì „ì˜ˆê³ -1ê°œì›”" }
    ]
};

// ìƒˆë¡œìš´ ì—°ì°¨ë£Œ ê¸°ë³¸ë£Œ í…Œì´ë¸” (ìµœì‹  ê¸°ì¤€)
const NEW_BASE_FEES = {
    1: 13000,   2: 13000,   3: 13000,        // 1~3ë…„ì°¨: 13,000ì›
    4: 36000,   5: 36000,   6: 36000,        // 4~6ë…„ì°¨: 36,000ì›
    7: 90000,   8: 90000,   9: 90000,        // 7~9ë…„ì°¨: 90,000ì›
    10: 216000, 11: 216000, 12: 216000,      // 10~12ë…„ì°¨: 216,000ì›
    13: 324000, 14: 324000, 15: 324000,      // 13~25ë…„ì°¨: 324,000ì›
    16: 324000, 17: 324000, 18: 324000,
    19: 324000, 20: 324000, 21: 324000, 22: 324000, 23: 324000, 24: 324000, 25: 324000
};

// ìƒˆë¡œìš´ ì²­êµ¬í•­ ê°€ì‚°ë£Œ í…Œì´ë¸” (ì²­êµ¬ë²”ìœ„ 1í•­ë§ˆë‹¤)
const NEW_CLAIM_FEES = {
    1: 12000,   2: 12000,   3: 12000,        // 1~3ë…„ì°¨: 12,000ì›
    4: 20000,   5: 20000,   6: 20000,        // 4~6ë…„ì°¨: 20,000ì›
    7: 34000,   8: 34000,   9: 34000,        // 7~9ë…„ì°¨: 34,000ì›
    10: 49000,  11: 49000,  12: 49000,       // 10~12ë…„ì°¨: 49,000ì›
    13: 49000,  14: 49000,  15: 49000,       // 13~25ë…„ì°¨: 49,000ì›
    16: 49000,  17: 49000,  18: 49000,
    19: 49000,  20: 49000,  21: 49000, 22: 49000, 23: 49000, 24: 49000, 25: 49000
};

// ì—°ì°¨ë£Œ ê³„ì‚° í—¬í¼ í•¨ìˆ˜ë“¤ (registered.ejsì™€ ë™ì¼)
function endOfMonthSafeAddMonths(d, months) {
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth();
    const targetY = y + Math.floor((m + months) / 12);
    const targetM = (m + months) % 12;
    const nextMonth = new Date(Date.UTC(
        targetM === 11 ? targetY + 1 : targetY,
        targetM === 11 ? 0 : targetM + 1,
        1
    ));
    const lastDay = new Date(nextMonth.getTime() - 24 * 60 * 60 * 1000).getUTCDate();
    const day = Math.min(d.getUTCDate(), lastDay);
    return new Date(Date.UTC(targetY, targetM, day));
}

function computeStatus(dueDate, today, policy) {
    const graceEnd = endOfMonthSafeAddMonths(dueDate, policy.grace_months);
    const recoveryEnd = endOfMonthSafeAddMonths(graceEnd, policy.recovery_months);
    if (today <= dueDate) return "ìœ íš¨";
    if (dueDate < today && today <= graceEnd) return "ì¶”ë‚©ê¸°ê°„";
    if (graceEnd < today && today <= recoveryEnd) return "íšŒë³µê¸°ê°„";
    return "ë¶ˆë‚©";
}

function wholeMonthsOverdue(due, today) {
    if (today <= due) return 0;
    let delta = (today.getUTCFullYear() - due.getUTCFullYear()) * 12
              + (today.getUTCMonth() - due.getUTCMonth());
    if (today.getUTCDate() <= due.getUTCDate()) delta -= 1;
    return Math.max(1, delta);
}

function applyRounding(amount, policy) {
    const mode = policy.rounding || "none";
    if (mode === "nearest_10") return Math.round(amount / 10) * 10;
    if (mode === "down_1") return Math.floor(amount);
    return Math.round(amount);
}

function computeLateFee(baseFee, monthsOverdue, policy) {
    const table = policy.late_fee_table || {};
    const key = String(Math.max(1, Math.min(monthsOverdue, 6)));
    const rate = table[key];
    if (!rate) return 0;
    return applyRounding(baseFee * rate, policy);
}

function computeRecoverySurcharge(baseFee, policy) {
    const rp = policy.recovery_policy || { type: "none" };
    if (rp.type === "multiplier") {
        const mult = rp.value || 1.0;
        const extra = baseFee * (mult - 1.0);
        return applyRounding(extra, policy);
    }
    return 0;
}

// ì—°ì°¨ìˆ˜ ê³„ì‚° (ë“±ë¡ì¼ë¶€í„° ê³„ì‚°)
function calculateAnnualYear(registrationDate, currentDate) {
    const regDate = new Date(registrationDate);
    const today = new Date(currentDate);
    const yearDiff = today.getFullYear() - regDate.getFullYear();
    const monthDiff = today.getMonth() - regDate.getMonth();
    const dayDiff = today.getDate() - regDate.getDate();
    
    let annualYear = yearDiff;
    if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
        annualYear--;
    }
    
    return Math.max(1, annualYear + 1); // ë“±ë¡ ë‹¤ìŒ ë…„ë„ë¶€í„° 1ë…„ì°¨
}

// ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼ ê³„ì‚° (ë“±ë¡ì¼ ê¸°ì¤€ìœ¼ë¡œ ë§¤ë…„)
function calculateDueDate(registrationDate, annualYear) {
    const regDate = new Date(registrationDate);
    const dueDate = new Date(regDate);
    dueDate.setFullYear(regDate.getFullYear() + annualYear);
    return dueDate;
}

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (main.jsì˜ í•¨ìˆ˜ë“¤ì„ ë¡œì»¬ì—ì„œ ì‚¬ìš©)
function showError(message) {
    alert(message); // ê°„ë‹¨í•œ alertë¡œ ëŒ€ì²´
}

function hideError() {
    // ë¡œì»¬ êµ¬í˜„ - í•„ìš”ì‹œ í™•ì¥
}

function formatDate(dateStr) {
    if (!dateStr || dateStr === '-') return '-';
    return dateStr;
}

// ìƒˆë¡œìš´ ì—°ì°¨ë£Œ ê³„ì‚°ì— ë”°ë¥¸ ê°ë©´ ìœ í˜• ì •ì˜
const NEW_DISCOUNT_TYPES = {
    'type1': { 
        name: 'ê°œì¸/ì¤‘ì†Œê¸°ì—…/ê³µê³µì—°êµ¬ê¸°ê´€/ì „ë‹´ì¡°ì§/ì§€ë°©ìì¹˜ë‹¨ì²´', 
        rate: 0.5,  // 50% ê°ë©´ (4ë…„ì°¨ë¶€í„° ì¡´ì†ê¸°ê°„ê¹Œì§€)
        description: 'ê°œì¸, ì¤‘ì†Œê¸°ì—…, ê³µê³µì—°êµ¬ê¸°ê´€, ì „ë‹´ì¡°ì§, ì§€ë°©ìì¹˜ë‹¨ì²´ ë“±ì´ í•´ë‹¹ë©ë‹ˆë‹¤.',
        applicableFromYear: 4
    },
    'type1_1': { 
        name: 'ì¤‘ì†Œê¸°ì—… + ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—…/ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…', 
        rate: 0.7,  // 4~9ë…„ì°¨ 70% ê°ë©´, 10ë…„ì°¨ë¶€í„° 50% ê°ë©´
        rate10Plus: 0.5,  // 10ë…„ì°¨ë¶€í„°ëŠ” 50% ê°ë©´
        description: 'ì¤‘ì†Œê¸°ì—…ì´ë©´ì„œ ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—… ë˜ëŠ” ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…ì…ë‹ˆë‹¤.',
        applicableFromYear: 4
    },
    'type2': { 
        name: 'ì¤‘ê²¬ê¸°ì—…', 
        rate: 0.3,  // 30% ê°ë©´ (4~9ë…„ì°¨)
        description: 'ì¤‘ê²¬ê¸°ì—…ì…ë‹ˆë‹¤.',
        applicableFromYear: 4,
        applicableToYear: 9
    },
    'type2_1': { 
        name: 'ì¤‘ê²¬ê¸°ì—… + ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—…/ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…', 
        rate: 0.5,  // 50% ê°ë©´ (4~9ë…„ì°¨)
        description: 'ì¤‘ê²¬ê¸°ì—…ì´ë©´ì„œ ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—… ë˜ëŠ” ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…ì…ë‹ˆë‹¤.',
        applicableFromYear: 4,
        applicableToYear: 9
    },
    'none': {
        name: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ',
        rate: 0,
        description: 'ê°ë©´ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤.',
        applicableFromYear: 1
    }
};

// ê³ ê°ë²ˆí˜¸ ì°¾ê¸° ë²„íŠ¼ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const findCustomerBtn = document.getElementById('findCustomerBtn');
    
    if (findCustomerBtn) {
        findCustomerBtn.addEventListener('click', function() {
            openCustomerSearchPopup();
        });
    }
});

function openCustomerSearchPopup() {
    const url = 'https://www.patent.go.kr/smart/jsp/kiponet/mp/mpopenpatinfo/apagtinfo/ReadApAgtInfoInput.do';
    const popupOptions = 'width=1000,height=800,scrollbars=yes,resizable=yes,status=yes,menubar=no,toolbar=no,location=no';
    
    // íŒì—…ì°½ ì—´ê¸°
    const popup = window.open(url, 'customerSearch', popupOptions);
    
    // íŒì—…ì°½ì´ ë¸”ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (!popup || popup.closed || typeof popup.closed === 'undefined') {
        alert('íŒì—… ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì €ì˜ íŒì—… ì°¨ë‹¨ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\në˜ëŠ” ë‹¤ìŒ ë§í¬ë¥¼ ì§ì ‘ ì—´ì–´ì£¼ì„¸ìš”:\n' + url);
        return;
    }
    
    // íŒì—…ì°½ ì¤‘ì•™ ì •ë ¬
    if (popup.moveTo) {
        const left = (screen.width - 1000) / 2;
        const top = (screen.height - 800) / 2;
        popup.moveTo(left, top);
    }
    
    // íŒì—…ì°½ í¬ì»¤ìŠ¤
    popup.focus();
}
</script>

<style>
/* í¬ë¡¤ë§ ìƒíƒœ í‘œì‹œ ìŠ¤íƒ€ì¼ */
.search-status {
    background: #f0f9ff;
    border: 1px solid #7dd3fc;
    border-radius: 8px;
    padding: 2rem;
    margin: 2rem 0;
    text-align: center;
}

.status-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e5e7eb;
    border-top: 4px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.status-message {
    font-size: 1.2rem;
    font-weight: 600;
    color: #1e40af;
}

.status-details {
    font-size: 0.9rem;
    color: #6b7280;
    max-width: 600px;
    line-height: 1.6;
}

.form-hint {
    font-size: 0.9rem;
    color: #6b7280;
    margin-top: 0.5rem;
}
</style>