<%- include('partials/header') %>

<main class="main-content">
    <div class="container">
        <div class="page-title">
            <h1>등록특허 현황</h1>
            <p>고객번호로 등록된 특허 목록을 조회합니다</p>
        </div>

        <!-- 검색 섹션 -->
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="customerNumber" class="form-label">고객번호</label>
                    <input 
                        type="text" 
                        id="customerNumber" 
                        name="customerNumber" 
                        class="form-input"
                        placeholder="예: 120190612244"
                        maxlength="12"
                        pattern="[0-9]{12}"
                        required
                    >
                    <div class="form-hint">12자리 숫자 입력하세요</div>
                </div>
                <button type="submit" class="btn btn-primary" id="searchBtn">
                    🔍 검색하기
                </button>
            </form>
        </section>

        <!-- 결과 섹션 -->
        <section class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-info">
                    <div class="info-item">
                        <span class="info-label">조회일자:</span>
                        <span class="info-value" id="resultCurrentDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">고객번호:</span>
                        <span class="info-value" id="resultCustomerNumber">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">출원인:</span>
                        <span class="info-value" id="resultApplicantName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">등록특허 수:</span>
                        <span class="info-value" id="resultTotalCount">0</span>건
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-info" id="calculateAnnuityBtn">
                        🧮 연차료 계산
                    </button>
                    <button type="button" class="btn btn-primary" id="renewalRequestBtn">
                        💰 연차료 납부의뢰
                    </button>
                    <button type="button" class="btn btn-secondary" id="exportBtn">
                        📊 엑셀 다운로드
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="patent-table" id="patentTable">
                    <thead>
                        <tr>
                            <th>출원번호</th>
                            <th>등록번호</th>
                            <th>출원인</th>
                            <th>발명자</th>
                            <th>출원일</th>
                            <th>등록일</th>
                            <th>존속기간 만료일</th>
                            <th>발명의명칭</th>
                            <th>청구항수</th>
                            <th>직전년도 납부연월</th>
                            <th>해당 연차료 납부마감일</th>
                            <th>해당연차수</th>
                            <th>해당연차료</th>
                            <th>유효/불납</th>
                            <th>차기년도 납부의뢰</th>
                            <th>추납기간</th>
                            <th>회복기간</th>
                            <th>특허평가</th>
                        </tr>
                    </thead>
                    <tbody id="patentTableBody">
                        <!-- 검색 결과가 여기에 표시됩니다 -->
                    </tbody>
                </table>
            </div>

            <!-- 빈 상태 -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">📄</div>
                <div class="empty-title">등록특허가 없습니다</div>
                <div class="empty-description">해당 고객번호로 등록된 특허를 찾을 수 없습니다.</div>
            </div>
        </section>
    </div>
</main>

<%- include('partials/footer') %>

<script>
// 캐시 무효화를 위한 버전 체크
console.log('🔄 납부의뢰 스크립트 로드됨 - 버전: 2025.08.21.v2');
</script>

<!-- 등록특허 검색 기능 및 연차료 계산 기능 -->
<script src="/js/registered.js?v=2025.08.21.v3"></script>

<script>
// 기존 연차료 계산 관련 상수들과 함수들은 외부 파일로 이동
// 이 섹션은 추가 기능을 위한 공간으로 사용

// 연차료 계산 정책 (annuity.txt에서 가져온 정책)
const ANNUITY_POLICY = {
    "name": "KIPO-default",
    "currency": "KRW",
    "grace_months": 6,
    "recovery_months": 3,
    "late_fee_table": {
        "1": 0.03,
        "2": 0.06,
        "3": 0.09,
        "4": 0.12,
        "5": 0.15,
        "6": 0.18
    },
    "recovery_policy": { "type": "multiplier", "value": 2.0 },
    "rounding": "nearest_10",
    "reminder_rules": [
        { "months_before_due": 6, "label": "사전예고-6개월" },
        { "months_before_due": 3, "label": "사전예고-3개월" },
        { "months_before_due": 1, "label": "사전예고-1개월" }
    ]
};

// KIPO 연차료 테이블 (2024년 기준)
const KIPO_ANNUITY_FEES = {
    1: 45000,   2: 45000,   3: 45000,
    4: 120000,  5: 120000,  6: 120000,
    7: 360000,  8: 360000,  9: 360000,
    10: 480000, 11: 480000, 12: 480000,
    13: 720000, 14: 720000, 15: 720000,
    16: 960000, 17: 960000, 18: 960000,
    19: 1200000, 20: 1200000
};

// 연차료 계산 헬퍼 함수들
function endOfMonthSafeAddMonths(d, months) {
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth();
    const targetY = y + Math.floor((m + months) / 12);
    const targetM = (m + months) % 12;
    const nextMonth = new Date(Date.UTC(
        targetM === 11 ? targetY + 1 : targetY,
        targetM === 11 ? 0 : targetM + 1,
        1
    ));
    const lastDay = new Date(nextMonth.getTime() - 24 * 60 * 60 * 1000).getUTCDate();
    const day = Math.min(d.getUTCDate(), lastDay);
    return new Date(Date.UTC(targetY, targetM, day));
}

function computeStatus(dueDate, today, policy) {
    const graceEnd = endOfMonthSafeAddMonths(dueDate, policy.grace_months);
    const recoveryEnd = endOfMonthSafeAddMonths(graceEnd, policy.recovery_months);
    if (today <= dueDate) return "유효";
    if (dueDate < today && today <= graceEnd) return "추납기간";
    if (graceEnd < today && today <= recoveryEnd) return "회복기간";
    return "불납";
}

function wholeMonthsOverdue(due, today) {
    if (today <= due) return 0;
    let delta = (today.getUTCFullYear() - due.getUTCFullYear()) * 12
              + (today.getUTCMonth() - due.getUTCMonth());
    if (today.getUTCDate() <= due.getUTCDate()) delta -= 1;
    return Math.max(1, delta);
}

function applyRounding(amount, policy) {
    const mode = policy.rounding || "none";
    if (mode === "nearest_10") return Math.round(amount / 10) * 10;
    if (mode === "down_1") return Math.floor(amount);
    return Math.round(amount);
}

function computeLateFee(baseFee, monthsOverdue, policy) {
    const table = policy.late_fee_table || {};
    const key = String(Math.max(1, Math.min(monthsOverdue, 6)));
    const rate = table[key];
    if (!rate) return 0;
    return applyRounding(baseFee * rate, policy);
}

function computeRecoverySurcharge(baseFee, policy) {
    const rp = policy.recovery_policy || { type: "none" };
    if (rp.type === "multiplier") {
        const mult = rp.value || 1.0;
        const extra = baseFee * (mult - 1.0);
        return applyRounding(extra, policy);
    }
    return 0;
}

// 연차수 계산 (등록일부터 계산)
function calculateAnnualYear(registrationDate, currentDate) {
    const regDate = new Date(registrationDate);
    const today = new Date(currentDate);
    const yearDiff = today.getFullYear() - regDate.getFullYear();
    const monthDiff = today.getMonth() - regDate.getMonth();
    const dayDiff = today.getDate() - regDate.getDate();
    
    let annualYear = yearDiff;
    if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
        annualYear--;
    }
    
    return Math.max(1, annualYear + 1); // 등록 다음 년도부터 1년차
}

// 연차료 납부마감일 계산 (등록일 기준으로 매년)
function calculateDueDate(registrationDate, annualYear) {
    const regDate = new Date(registrationDate);
    const dueDate = new Date(regDate);
    dueDate.setFullYear(regDate.getFullYear() + annualYear);
    return dueDate;
}

// 연차료 계산 메인 함수
function calculateAnnuityFees() {
    // 외부 스크립트의 currentPatents 변수 사용
    if (!window.currentPatents || window.currentPatents.length === 0) {
        showError('계산할 특허가 없습니다.');
        return;
    }
    
    const today = new Date();
    const tableBody = document.getElementById('patentTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    
    window.currentPatents.forEach((patent, index) => {
        if (index >= rows.length) return;
        
        const row = rows[index];
        const cells = row.getElementsByTagName('td');
        
        // 등록일이 있는 경우에만 계산
        if (patent.registrationDate && patent.registrationDate !== '-') {
            const registrationDate = new Date(patent.registrationDate);
            const annualYear = calculateAnnualYear(patent.registrationDate, today);
            
            // 연차수가 20년을 초과하면 특허 만료
            if (annualYear > 20) {
                cells[10].textContent = '-'; // 해당 연차료 납부마감일
                cells[11].textContent = '만료'; // 해당연차수
                cells[12].textContent = '-'; // 해당연차료
                cells[13].textContent = '만료'; // 유효/불납
                cells[14].textContent = '-'; // 차기년도 납부의뢰
                cells[15].textContent = '-'; // 추납기간
                cells[16].textContent = '-'; // 회복기간
                return;
            }
            
            const dueDate = calculateDueDate(patent.registrationDate, annualYear);
            const baseFee = KIPO_ANNUITY_FEES[annualYear] || 0;
            const status = computeStatus(dueDate, today, ANNUITY_POLICY);
            
            let totalFee = baseFee;
            let lateFee = 0;
            let recoverySurcharge = 0;
            
            // 상태에 따른 추가 비용 계산
            if (status === "추납기간") {
                const monthsOverdue = wholeMonthsOverdue(dueDate, today);
                lateFee = computeLateFee(baseFee, monthsOverdue, ANNUITY_POLICY);
                totalFee = baseFee + lateFee;
            } else if (status === "회복기간") {
                recoverySurcharge = computeRecoverySurcharge(baseFee, ANNUITY_POLICY);
                totalFee = baseFee + recoverySurcharge;
            }
            
            // 기간 계산
            const graceEnd = endOfMonthSafeAddMonths(dueDate, ANNUITY_POLICY.grace_months);
            const recoveryEnd = endOfMonthSafeAddMonths(graceEnd, ANNUITY_POLICY.recovery_months);
            
            // 결과 표시
            cells[10].textContent = formatDate(dueDate.toISOString().split('T')[0]); // 해당 연차료 납부마감일
            cells[11].textContent = annualYear + '년차'; // 해당연차수
            cells[12].textContent = totalFee.toLocaleString() + '원'; // 해당연차료
            cells[13].textContent = status; // 유효/불납
            
            // 차기년도 납부의뢰 (현재 연차가 유효하고 다음 연차가 20년 이내인 경우)
            const nextYear = annualYear + 1;
            if (status === "유효" && nextYear <= 20) {
                const nextDueDate = calculateDueDate(patent.registrationDate, nextYear);
                const nextFee = KIPO_ANNUITY_FEES[nextYear] || 0;
                cells[14].textContent = nextYear + '년차 ' + nextFee.toLocaleString() + '원 (' + formatDate(nextDueDate.toISOString().split('T')[0]) + ' 마감)';
            } else {
                cells[14].textContent = '-';
            }
            
            // 추납기간
            if (status === "유효") {
                cells[15].textContent = formatDate(dueDate.toISOString().split('T')[0]) + ' ~ ' + formatDate(graceEnd.toISOString().split('T')[0]);
            } else if (status === "추납기간") {
                cells[15].textContent = '진행중 (' + formatDate(graceEnd.toISOString().split('T')[0]) + ' 마감)';
            } else {
                cells[15].textContent = '-';
            }
            
            // 회복기간
            if (status === "유효" || status === "추납기간") {
                cells[16].textContent = formatDate(graceEnd.toISOString().split('T')[0]) + ' ~ ' + formatDate(recoveryEnd.toISOString().split('T')[0]);
            } else if (status === "회복기간") {
                cells[16].textContent = '진행중 (' + formatDate(recoveryEnd.toISOString().split('T')[0]) + ' 마감)';
            } else {
                cells[16].textContent = '-';
            }
        } else {
            // 등록일이 없는 경우
            cells[10].textContent = '-';
            cells[11].textContent = '-';
            cells[12].textContent = '-';
            cells[13].textContent = '-';
            cells[14].textContent = '-';
            cells[15].textContent = '-';
            cells[16].textContent = '-';
        }
    });
    
    // 계산 완료 메시지
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.textContent = '연차료 계산이 완료되었습니다.';
    successDiv.style.cssText = 'background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; text-align: center;';
    
    const resultsSection = document.getElementById('resultsSection');
    const existingSuccess = document.querySelector('.success-message');
    if (existingSuccess) {
        existingSuccess.remove();
    }
    resultsSection.insertBefore(successDiv, resultsSection.firstChild);
    
    // 3초 후 메시지 제거
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.remove();
        }
    }, 3000);
}

// 연차료 납부의뢰 관련 함수들은 외부 스크립트 파일 (registered.js)에서 처리됩니다.
</script>