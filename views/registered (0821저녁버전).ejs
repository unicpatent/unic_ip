<%- include('partials/header') %>

<main class="main-content">
    <div class="container">
        <div class="page-title">
            <h1>ë“±ë¡íŠ¹í—ˆ í˜„í™©</h1>
            <p>ê³ ê°ë²ˆí˜¸ë¡œ ë“±ë¡ëœ íŠ¹í—ˆ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤</p>
        </div>

        <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="customerNumber" class="form-label">ê³ ê°ë²ˆí˜¸</label>
                    <input 
                        type="text" 
                        id="customerNumber" 
                        name="customerNumber" 
                        class="form-input"
                        placeholder="ì˜ˆ: 120190612244"
                        maxlength="12"
                        pattern="[0-9]{12}"
                        required
                    >
                    <div class="form-hint">12ìë¦¬ ìˆ«ì ì…ë ¥í•˜ì„¸ìš”</div>
                </div>
                <button type="submit" class="btn btn-primary" id="searchBtn">
                    ğŸ” ê²€ìƒ‰í•˜ê¸°
                </button>
            </form>
        </section>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <section class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-info">
                    <div class="info-item">
                        <span class="info-label">ì¡°íšŒì¼ì:</span>
                        <span class="info-value" id="resultCurrentDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ê³ ê°ë²ˆí˜¸:</span>
                        <span class="info-value" id="resultCustomerNumber">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì¶œì›ì¸:</span>
                        <span class="info-value" id="resultApplicantName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ë“±ë¡íŠ¹í—ˆ ìˆ˜:</span>
                        <span class="info-value" id="resultTotalCount">0</span>ê±´
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-info" id="calculateAnnuityBtn">
                        ğŸ§® ì—°ì°¨ë£Œ ê³„ì‚°
                    </button>
                    <button type="button" class="btn btn-primary" id="renewalRequestBtn">
                        ğŸ’° ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢°
                    </button>
                    <button type="button" class="btn btn-secondary" id="exportBtn">
                        ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="patent-table" id="patentTable">
                    <thead>
                        <tr>
                            <th>ì¶œì›ë²ˆí˜¸</th>
                            <th>ë“±ë¡ë²ˆí˜¸</th>
                            <th>ì¶œì›ì¸</th>
                            <th>ë°œëª…ì</th>
                            <th>ì¶œì›ì¼</th>
                            <th>ë“±ë¡ì¼</th>
                            <th>ì¡´ì†ê¸°ê°„ ë§Œë£Œì¼</th>
                            <th>ë°œëª…ì˜ëª…ì¹­</th>
                            <th>ì²­êµ¬í•­ìˆ˜</th>
                            <th>ì§ì „ë…„ë„ ë‚©ë¶€ì—°ì›”</th>
                            <th>í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼</th>
                            <th>í•´ë‹¹ì—°ì°¨ìˆ˜</th>
                            <th>í•´ë‹¹ì—°ì°¨ë£Œ</th>
                            <th>ìœ íš¨/ë¶ˆë‚©</th>
                            <th>ì°¨ê¸°ë…„ë„ ë‚©ë¶€ì˜ë¢°</th>
                            <th>ì¶”ë‚©ê¸°ê°„</th>
                            <th>íšŒë³µê¸°ê°„</th>
                            <th>íŠ¹í—ˆí‰ê°€</th>
                        </tr>
                    </thead>
                    <tbody id="patentTableBody">
                        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“„</div>
                <div class="empty-title">ë“±ë¡íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="empty-description">í•´ë‹¹ ê³ ê°ë²ˆí˜¸ë¡œ ë“±ë¡ëœ íŠ¹í—ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </section>
    </div>
</main>

<%- include('partials/footer') %>

<script>
// ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ë²„ì „ ì²´í¬
console.log('ğŸ”„ ë‚©ë¶€ì˜ë¢° ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨ - ë²„ì „: 2025.08.21.v2');
</script>

<!-- ë“±ë¡íŠ¹í—ˆ ê²€ìƒ‰ ê¸°ëŠ¥ ë° ì—°ì°¨ë£Œ ê³„ì‚° ê¸°ëŠ¥ -->
<script src="/js/registered.js?v=2025.08.21.v3"></script>

<script>
// ê¸°ì¡´ ì—°ì°¨ë£Œ ê³„ì‚° ê´€ë ¨ ìƒìˆ˜ë“¤ê³¼ í•¨ìˆ˜ë“¤ì€ ì™¸ë¶€ íŒŒì¼ë¡œ ì´ë™
// ì´ ì„¹ì…˜ì€ ì¶”ê°€ ê¸°ëŠ¥ì„ ìœ„í•œ ê³µê°„ìœ¼ë¡œ ì‚¬ìš©

// ì—°ì°¨ë£Œ ê³„ì‚° ì •ì±… (annuity.txtì—ì„œ ê°€ì ¸ì˜¨ ì •ì±…)
const ANNUITY_POLICY = {
    "name": "KIPO-default",
    "currency": "KRW",
    "grace_months": 6,
    "recovery_months": 3,
    "late_fee_table": {
        "1": 0.03,
        "2": 0.06,
        "3": 0.09,
        "4": 0.12,
        "5": 0.15,
        "6": 0.18
    },
    "recovery_policy": { "type": "multiplier", "value": 2.0 },
    "rounding": "nearest_10",
    "reminder_rules": [
        { "months_before_due": 6, "label": "ì‚¬ì „ì˜ˆê³ -6ê°œì›”" },
        { "months_before_due": 3, "label": "ì‚¬ì „ì˜ˆê³ -3ê°œì›”" },
        { "months_before_due": 1, "label": "ì‚¬ì „ì˜ˆê³ -1ê°œì›”" }
    ]
};

// KIPO ì—°ì°¨ë£Œ í…Œì´ë¸” (2024ë…„ ê¸°ì¤€)
const KIPO_ANNUITY_FEES = {
    1: 45000,   2: 45000,   3: 45000,
    4: 120000,  5: 120000,  6: 120000,
    7: 360000,  8: 360000,  9: 360000,
    10: 480000, 11: 480000, 12: 480000,
    13: 720000, 14: 720000, 15: 720000,
    16: 960000, 17: 960000, 18: 960000,
    19: 1200000, 20: 1200000
};

// ì—°ì°¨ë£Œ ê³„ì‚° í—¬í¼ í•¨ìˆ˜ë“¤
function endOfMonthSafeAddMonths(d, months) {
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth();
    const targetY = y + Math.floor((m + months) / 12);
    const targetM = (m + months) % 12;
    const nextMonth = new Date(Date.UTC(
        targetM === 11 ? targetY + 1 : targetY,
        targetM === 11 ? 0 : targetM + 1,
        1
    ));
    const lastDay = new Date(nextMonth.getTime() - 24 * 60 * 60 * 1000).getUTCDate();
    const day = Math.min(d.getUTCDate(), lastDay);
    return new Date(Date.UTC(targetY, targetM, day));
}

function computeStatus(dueDate, today, policy) {
    const graceEnd = endOfMonthSafeAddMonths(dueDate, policy.grace_months);
    const recoveryEnd = endOfMonthSafeAddMonths(graceEnd, policy.recovery_months);
    if (today <= dueDate) return "ìœ íš¨";
    if (dueDate < today && today <= graceEnd) return "ì¶”ë‚©ê¸°ê°„";
    if (graceEnd < today && today <= recoveryEnd) return "íšŒë³µê¸°ê°„";
    return "ë¶ˆë‚©";
}

function wholeMonthsOverdue(due, today) {
    if (today <= due) return 0;
    let delta = (today.getUTCFullYear() - due.getUTCFullYear()) * 12
              + (today.getUTCMonth() - due.getUTCMonth());
    if (today.getUTCDate() <= due.getUTCDate()) delta -= 1;
    return Math.max(1, delta);
}

function applyRounding(amount, policy) {
    const mode = policy.rounding || "none";
    if (mode === "nearest_10") return Math.round(amount / 10) * 10;
    if (mode === "down_1") return Math.floor(amount);
    return Math.round(amount);
}

function computeLateFee(baseFee, monthsOverdue, policy) {
    const table = policy.late_fee_table || {};
    const key = String(Math.max(1, Math.min(monthsOverdue, 6)));
    const rate = table[key];
    if (!rate) return 0;
    return applyRounding(baseFee * rate, policy);
}

function computeRecoverySurcharge(baseFee, policy) {
    const rp = policy.recovery_policy || { type: "none" };
    if (rp.type === "multiplier") {
        const mult = rp.value || 1.0;
        const extra = baseFee * (mult - 1.0);
        return applyRounding(extra, policy);
    }
    return 0;
}

// ì—°ì°¨ìˆ˜ ê³„ì‚° (ë“±ë¡ì¼ë¶€í„° ê³„ì‚°)
function calculateAnnualYear(registrationDate, currentDate) {
    const regDate = new Date(registrationDate);
    const today = new Date(currentDate);
    const yearDiff = today.getFullYear() - regDate.getFullYear();
    const monthDiff = today.getMonth() - regDate.getMonth();
    const dayDiff = today.getDate() - regDate.getDate();
    
    let annualYear = yearDiff;
    if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
        annualYear--;
    }
    
    return Math.max(1, annualYear + 1); // ë“±ë¡ ë‹¤ìŒ ë…„ë„ë¶€í„° 1ë…„ì°¨
}

// ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼ ê³„ì‚° (ë“±ë¡ì¼ ê¸°ì¤€ìœ¼ë¡œ ë§¤ë…„)
function calculateDueDate(registrationDate, annualYear) {
    const regDate = new Date(registrationDate);
    const dueDate = new Date(regDate);
    dueDate.setFullYear(regDate.getFullYear() + annualYear);
    return dueDate;
}

// ì—°ì°¨ë£Œ ê³„ì‚° ë©”ì¸ í•¨ìˆ˜
function calculateAnnuityFees() {
    // ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ì˜ currentPatents ë³€ìˆ˜ ì‚¬ìš©
    if (!window.currentPatents || window.currentPatents.length === 0) {
        showError('ê³„ì‚°í•  íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const today = new Date();
    const tableBody = document.getElementById('patentTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    
    window.currentPatents.forEach((patent, index) => {
        if (index >= rows.length) return;
        
        const row = rows[index];
        const cells = row.getElementsByTagName('td');
        
        // ë“±ë¡ì¼ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ê³„ì‚°
        if (patent.registrationDate && patent.registrationDate !== '-') {
            const registrationDate = new Date(patent.registrationDate);
            const annualYear = calculateAnnualYear(patent.registrationDate, today);
            
            // ì—°ì°¨ìˆ˜ê°€ 20ë…„ì„ ì´ˆê³¼í•˜ë©´ íŠ¹í—ˆ ë§Œë£Œ
            if (annualYear > 20) {
                cells[10].textContent = '-'; // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
                cells[11].textContent = 'ë§Œë£Œ'; // í•´ë‹¹ì—°ì°¨ìˆ˜
                cells[12].textContent = '-'; // í•´ë‹¹ì—°ì°¨ë£Œ
                cells[13].textContent = 'ë§Œë£Œ'; // ìœ íš¨/ë¶ˆë‚©
                cells[14].textContent = '-'; // ì°¨ê¸°ë…„ë„ ë‚©ë¶€ì˜ë¢°
                cells[15].textContent = '-'; // ì¶”ë‚©ê¸°ê°„
                cells[16].textContent = '-'; // íšŒë³µê¸°ê°„
                return;
            }
            
            const dueDate = calculateDueDate(patent.registrationDate, annualYear);
            const baseFee = KIPO_ANNUITY_FEES[annualYear] || 0;
            const status = computeStatus(dueDate, today, ANNUITY_POLICY);
            
            let totalFee = baseFee;
            let lateFee = 0;
            let recoverySurcharge = 0;
            
            // ìƒíƒœì— ë”°ë¥¸ ì¶”ê°€ ë¹„ìš© ê³„ì‚°
            if (status === "ì¶”ë‚©ê¸°ê°„") {
                const monthsOverdue = wholeMonthsOverdue(dueDate, today);
                lateFee = computeLateFee(baseFee, monthsOverdue, ANNUITY_POLICY);
                totalFee = baseFee + lateFee;
            } else if (status === "íšŒë³µê¸°ê°„") {
                recoverySurcharge = computeRecoverySurcharge(baseFee, ANNUITY_POLICY);
                totalFee = baseFee + recoverySurcharge;
            }
            
            // ê¸°ê°„ ê³„ì‚°
            const graceEnd = endOfMonthSafeAddMonths(dueDate, ANNUITY_POLICY.grace_months);
            const recoveryEnd = endOfMonthSafeAddMonths(graceEnd, ANNUITY_POLICY.recovery_months);
            
            // ê²°ê³¼ í‘œì‹œ
            cells[10].textContent = formatDate(dueDate.toISOString().split('T')[0]); // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
            cells[11].textContent = annualYear + 'ë…„ì°¨'; // í•´ë‹¹ì—°ì°¨ìˆ˜
            cells[12].textContent = totalFee.toLocaleString() + 'ì›'; // í•´ë‹¹ì—°ì°¨ë£Œ
            cells[13].textContent = status; // ìœ íš¨/ë¶ˆë‚©
            
            // ì°¨ê¸°ë…„ë„ ë‚©ë¶€ì˜ë¢° (í˜„ì¬ ì—°ì°¨ê°€ ìœ íš¨í•˜ê³  ë‹¤ìŒ ì—°ì°¨ê°€ 20ë…„ ì´ë‚´ì¸ ê²½ìš°)
            const nextYear = annualYear + 1;
            if (status === "ìœ íš¨" && nextYear <= 20) {
                const nextDueDate = calculateDueDate(patent.registrationDate, nextYear);
                const nextFee = KIPO_ANNUITY_FEES[nextYear] || 0;
                cells[14].textContent = nextYear + 'ë…„ì°¨ ' + nextFee.toLocaleString() + 'ì› (' + formatDate(nextDueDate.toISOString().split('T')[0]) + ' ë§ˆê°)';
            } else {
                cells[14].textContent = '-';
            }
            
            // ì¶”ë‚©ê¸°ê°„
            if (status === "ìœ íš¨") {
                cells[15].textContent = formatDate(dueDate.toISOString().split('T')[0]) + ' ~ ' + formatDate(graceEnd.toISOString().split('T')[0]);
            } else if (status === "ì¶”ë‚©ê¸°ê°„") {
                cells[15].textContent = 'ì§„í–‰ì¤‘ (' + formatDate(graceEnd.toISOString().split('T')[0]) + ' ë§ˆê°)';
            } else {
                cells[15].textContent = '-';
            }
            
            // íšŒë³µê¸°ê°„
            if (status === "ìœ íš¨" || status === "ì¶”ë‚©ê¸°ê°„") {
                cells[16].textContent = formatDate(graceEnd.toISOString().split('T')[0]) + ' ~ ' + formatDate(recoveryEnd.toISOString().split('T')[0]);
            } else if (status === "íšŒë³µê¸°ê°„") {
                cells[16].textContent = 'ì§„í–‰ì¤‘ (' + formatDate(recoveryEnd.toISOString().split('T')[0]) + ' ë§ˆê°)';
            } else {
                cells[16].textContent = '-';
            }
        } else {
            // ë“±ë¡ì¼ì´ ì—†ëŠ” ê²½ìš°
            cells[10].textContent = '-';
            cells[11].textContent = '-';
            cells[12].textContent = '-';
            cells[13].textContent = '-';
            cells[14].textContent = '-';
            cells[15].textContent = '-';
            cells[16].textContent = '-';
        }
    });
    
    // ê³„ì‚° ì™„ë£Œ ë©”ì‹œì§€
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.textContent = 'ì—°ì°¨ë£Œ ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
    successDiv.style.cssText = 'background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; text-align: center;';
    
    const resultsSection = document.getElementById('resultsSection');
    const existingSuccess = document.querySelector('.success-message');
    if (existingSuccess) {
        existingSuccess.remove();
    }
    resultsSection.insertBefore(successDiv, resultsSection.firstChild);
    
    // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.remove();
        }
    }, 3000);
}

// ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢° ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ (registered.js)ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
</script>