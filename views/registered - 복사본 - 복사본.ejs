<%- include('partials/header') %>

<main class="main-content">
    <div class="container">
        <div class="page-title">
            <h1>ë“±ë¡íŠ¹í—ˆ í˜„í™©</h1>
            <p>ê³ ê°ë²ˆí˜¸ë¡œ ë“±ë¡ëœ íŠ¹í—ˆ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤</p>
        </div>

        <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="customerNumber" class="form-label">ê³ ê°ë²ˆí˜¸</label>
                    <input 
                        type="text" 
                        id="customerNumber" 
                        name="customerNumber" 
                        class="form-input"
                        placeholder="ì˜ˆ: 120190612244"
                        maxlength="12"
                        pattern="[0-9]{12}"
                        required
                    >
                    <div class="form-hint">12ìë¦¬ ìˆ«ì ì…ë ¥í•˜ì„¸ìš”</div>
                </div>
                <button type="submit" class="btn btn-primary" id="searchBtn">
                    ğŸ” ê²€ìƒ‰í•˜ê¸°
                </button>
            </form>
        </section>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <section class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-info">
                    <div class="info-item">
                        <span class="info-label">ì¡°íšŒì¼ì:</span>
                        <span class="info-value" id="resultCurrentDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ê³ ê°ë²ˆí˜¸:</span>
                        <span class="info-value" id="resultCustomerNumber">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì¶œì›ì¸:</span>
                        <span class="info-value" id="resultApplicantName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ë“±ë¡íŠ¹í—ˆ ìˆ˜:</span>
                        <span class="info-value" id="resultTotalCount">0</span>ê±´
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-info" id="calculateAnnuityBtn">
                        ğŸ§® ì—°ì°¨ë£Œ ê³„ì‚°
                    </button>
                    <button type="button" class="btn btn-primary" id="renewalRequestBtn">
                        ğŸ’° ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢°
                    </button>
                    <button type="button" class="btn btn-secondary" id="exportBtn">
                        ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="patent-table" id="patentTable">
                    <thead>
                        <tr>
                            <th>ì¶œì›ë²ˆí˜¸</th>
                            <th>ë“±ë¡ë²ˆí˜¸</th>
                            <th>ì¶œì›ì¸</th>
                            <th>ë°œëª…ì</th>
                            <th>ì¶œì›ì¼</th>
                            <th>ë“±ë¡ì¼</th>
                            <th>ì¡´ì†ê¸°ê°„ ë§Œë£Œì¼</th>
                            <th>ë°œëª…ì˜ëª…ì¹­</th>
                            <th>ì²­êµ¬í•­ìˆ˜</th>
                            <th>ì§ì „ë…„ë„ ë‚©ë¶€ì—°ì›”</th>
                            <th>í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼</th>
                            <th>í•´ë‹¹ì—°ì°¨ìˆ˜</th>
                            <th>í•´ë‹¹ì—°ì°¨ë£Œ</th>
                            <th>ìœ íš¨/ë¶ˆë‚©</th>
                            <th>ì°¨ê¸°ë…„ë„ ë‚©ë¶€ì˜ë¢°</th>
                            <th>ì¶”ë‚©ê¸°ê°„</th>
                            <th>íšŒë³µê¸°ê°„</th>
                            <th>íŠ¹í—ˆí‰ê°€</th>
                        </tr>
                    </thead>
                    <tbody id="patentTableBody">
                        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“„</div>
                <div class="empty-title">ë“±ë¡íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="empty-description">í•´ë‹¹ ê³ ê°ë²ˆí˜¸ë¡œ ë“±ë¡ëœ íŠ¹í—ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </section>
    </div>
</main>

<%- include('partials/footer') %>

<script>
// ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ë²„ì „ ì²´í¬
console.log('ğŸ”„ ë‚©ë¶€ì˜ë¢° ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨ - ë²„ì „: 2025.08.21.v2');
</script>

<script>
let currentPatents = [];

// í¼ ì œì¶œ ì´ë²¤íŠ¸
document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const customerNumber = document.getElementById('customerNumber').value.trim();
    const searchBtn = document.getElementById('searchBtn');
    const originalText = searchBtn.innerHTML;
    
    // ì…ë ¥ ê²€ì¦ (12ìë¦¬ ìˆ«ì)
    if (!/^\d{12}$/.test(customerNumber)) {
        showError('ê³ ê°ë²ˆí˜¸ëŠ” 12ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    hideError();
    showLoading(searchBtn);
    
    try {
        const response = await fetch('/api/search-registered', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ customerNumber })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
        
        displayResults(data);
        
        // íŠ¹í—ˆ ìƒì„¸ ì •ë³´ ì¡°íšŒ (ë“±ë¡ë²ˆí˜¸, ë“±ë¡ì¼, ì¡´ì†ê¸°ê°„ë§Œë£Œì¼, ì²­êµ¬í•­ìˆ˜)
        try {
            showDetailLoadingMessage();
            await fetchPatentDetails(data.patents);
            hideDetailLoadingMessage();
        } catch (detailError) {
            console.error('ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨, ê¸°ë³¸ ì •ë³´ë§Œ í‘œì‹œ:', detailError);
            hideDetailLoadingMessage();
            // ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ ê²°ê³¼ëŠ” ìœ ì§€
        }
        
    } catch (error) {
        console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        showError(error.message);
        hideResults();
        hideDetailLoadingMessage();
    } finally {
        hideLoading(searchBtn, originalText);
    }
});

// ê²°ê³¼ í‘œì‹œ
function displayResults(data) {
    currentPatents = data.patents || [];
    
    // í˜„ì¬ ë‚ ì§œ í‘œì‹œ
    const currentDate = new Date().toLocaleDateString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
    document.getElementById('resultCurrentDate').textContent = currentDate;
    document.getElementById('resultCustomerNumber').textContent = data.customerNumber;
    document.getElementById('resultApplicantName').textContent = data.applicantName;
    document.getElementById('resultTotalCount').textContent = data.totalCount;
    
    const tableBody = document.getElementById('patentTableBody');
    const emptyState = document.getElementById('emptyState');
    const resultsSection = document.getElementById('resultsSection');
    
    tableBody.innerHTML = '';
    
    if (currentPatents.length === 0) {
        emptyState.style.display = 'block';
        document.querySelector('.table-container').style.display = 'none';
    } else {
        emptyState.style.display = 'none';
        document.querySelector('.table-container').style.display = 'block';
        
        currentPatents.forEach(patent => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${patent.applicationNumber}</td>
                <td>${patent.registrationNumber}</td>
                <td>${patent.applicantName}</td>
                <td>${patent.inventorName}</td>
                <td>${formatDate(patent.applicationDate)}</td>
                <td>${formatDate(patent.registrationDate)}</td>
                <td>${formatDate(patent.expirationDate)}</td>
                <td style="max-width: 300px; word-break: break-word;">${patent.inventionTitle}</td>
                <td>${patent.claimCount}</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    resultsSection.style.display = 'block';
}

// íŠ¹í—ˆ ìƒì„¸ ì •ë³´ ì¡°íšŒ
async function fetchPatentDetails(patents) {
    if (!patents || patents.length === 0) return;
    
    try {
        // ì¶œì›ë²ˆí˜¸ ëª©ë¡ ì¶”ì¶œ
        const applicationNumbers = patents.map(p => p.applicationNumber).filter(num => num && num !== '-');
        
        if (applicationNumbers.length === 0) return;
        
        const response = await fetch('/api/get-patent-details', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ applicationNumbers })
        });
        
        const data = await response.json();
        
        if (data.success && data.details) {
            updatePatentTable(data.details);
        }
        
    } catch (error) {
        console.error('íŠ¹í—ˆ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
        // ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ëŠ” ì—ëŸ¬ë¡œ í‘œì‹œí•˜ì§€ ì•Šê³  ì¡°ìš©íˆ ì²˜ë¦¬
    }
}

// íŠ¹í—ˆ í…Œì´ë¸” ì—…ë°ì´íŠ¸
function updatePatentTable(details) {
    const tableBody = document.getElementById('patentTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    
    currentPatents.forEach((patent, index) => {
        if (index >= rows.length) return;
        
        const row = rows[index];
        const cells = row.getElementsByTagName('td');
        const applicationNumber = patent.applicationNumber;
        
        // ìƒì„¸ ì •ë³´ê°€ ìˆëŠ” ê²½ìš° ì—…ë°ì´íŠ¸
        if (details[applicationNumber]) {
            const detail = details[applicationNumber];
            
            // ë“±ë¡ë²ˆí˜¸ (ì»¬ëŸ¼ 1)
            if (detail.registrationNumber && detail.registrationNumber !== '-') {
                cells[1].textContent = detail.registrationNumber;
                currentPatents[index].registrationNumber = detail.registrationNumber;
            }
            
            // ë“±ë¡ì¼ (ì»¬ëŸ¼ 5)
            if (detail.registrationDate && detail.registrationDate !== '-') {
                cells[5].textContent = formatDate(detail.registrationDate);
                currentPatents[index].registrationDate = detail.registrationDate;
            }
            
            // ì¡´ì†ê¸°ê°„ ë§Œë£Œì¼ (ì»¬ëŸ¼ 6)
            if (detail.expirationDate && detail.expirationDate !== '-') {
                cells[6].textContent = formatDate(detail.expirationDate);
                currentPatents[index].expirationDate = detail.expirationDate;
            }
            
            // ì²­êµ¬í•­ìˆ˜ (ì»¬ëŸ¼ 8)
            if (detail.claimCount && detail.claimCount !== '-') {
                cells[8].textContent = detail.claimCount;
                currentPatents[index].claimCount = detail.claimCount;
            }
        }
    });
}

// ìƒì„¸ ì •ë³´ ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
function showDetailLoadingMessage() {
    const existingMessage = document.querySelector('.detail-loading-message');
    if (existingMessage) {
        existingMessage.remove();
    }

    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'detail-loading-message';
    loadingDiv.innerHTML = 'ğŸ” ìƒì„¸ ì •ë³´ë¥¼ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...';
    loadingDiv.style.cssText = 'background: #e0f2fe; color: #01579b; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; text-align: center;';
    
    const resultsSection = document.getElementById('resultsSection');
    const tableContainer = resultsSection.querySelector('.table-container');
    if (tableContainer) {
        tableContainer.before(loadingDiv);
    }
}

// ìƒì„¸ ì •ë³´ ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
function hideDetailLoadingMessage() {
    const existingMessage = document.querySelector('.detail-loading-message');
    if (existingMessage) {
        existingMessage.remove();
    }
}

// ê²°ê³¼ ìˆ¨ê¸°ê¸°
function hideResults() {
    document.getElementById('resultsSection').style.display = 'none';
}

// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function exportToExcel() {
    if (currentPatents.length === 0) {
        showError('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    downloadExcel(currentPatents, 'registered');
}

// ì—°ì°¨ë£Œ ê³„ì‚° ì •ì±… (annuity.txtì—ì„œ ê°€ì ¸ì˜¨ ì •ì±…)
const ANNUITY_POLICY = {
    "name": "KIPO-default",
    "currency": "KRW",
    "grace_months": 6,
    "recovery_months": 3,
    "late_fee_table": {
        "1": 0.03,
        "2": 0.06,
        "3": 0.09,
        "4": 0.12,
        "5": 0.15,
        "6": 0.18
    },
    "recovery_policy": { "type": "multiplier", "value": 2.0 },
    "rounding": "nearest_10",
    "reminder_rules": [
        { "months_before_due": 6, "label": "ì‚¬ì „ì˜ˆê³ -6ê°œì›”" },
        { "months_before_due": 3, "label": "ì‚¬ì „ì˜ˆê³ -3ê°œì›”" },
        { "months_before_due": 1, "label": "ì‚¬ì „ì˜ˆê³ -1ê°œì›”" }
    ]
};

// KIPO ì—°ì°¨ë£Œ í…Œì´ë¸” (2024ë…„ ê¸°ì¤€)
const KIPO_ANNUITY_FEES = {
    1: 45000,   2: 45000,   3: 45000,
    4: 120000,  5: 120000,  6: 120000,
    7: 360000,  8: 360000,  9: 360000,
    10: 480000, 11: 480000, 12: 480000,
    13: 720000, 14: 720000, 15: 720000,
    16: 960000, 17: 960000, 18: 960000,
    19: 1200000, 20: 1200000
};

// ì—°ì°¨ë£Œ ê³„ì‚° í•¨ìˆ˜ë“¤
function endOfMonthSafeAddMonths(d, months) {
    const y = d.getUTCFullYear();
    const m = d.getUTCMonth();
    const targetY = y + Math.floor((m + months) / 12);
    const targetM = (m + months) % 12;
    const nextMonth = new Date(Date.UTC(
        targetM === 11 ? targetY + 1 : targetY,
        targetM === 11 ? 0 : targetM + 1,
        1
    ));
    const lastDay = new Date(nextMonth.getTime() - 24 * 60 * 60 * 1000).getUTCDate();
    const day = Math.min(d.getUTCDate(), lastDay);
    return new Date(Date.UTC(targetY, targetM, day));
}

function computeStatus(dueDate, today, policy) {
    const graceEnd = endOfMonthSafeAddMonths(dueDate, policy.grace_months);
    const recoveryEnd = endOfMonthSafeAddMonths(graceEnd, policy.recovery_months);
    if (today <= dueDate) return "ìœ íš¨";
    if (dueDate < today && today <= graceEnd) return "ì¶”ë‚©ê¸°ê°„";
    if (graceEnd < today && today <= recoveryEnd) return "íšŒë³µê¸°ê°„";
    return "ë¶ˆë‚©";
}

function wholeMonthsOverdue(due, today) {
    if (today <= due) return 0;
    let delta = (today.getUTCFullYear() - due.getUTCFullYear()) * 12
              + (today.getUTCMonth() - due.getUTCMonth());
    if (today.getUTCDate() <= due.getUTCDate()) delta -= 1;
    return Math.max(1, delta);
}

function applyRounding(amount, policy) {
    const mode = policy.rounding || "none";
    if (mode === "nearest_10") return Math.round(amount / 10) * 10;
    if (mode === "down_1") return Math.floor(amount);
    return Math.round(amount);
}

function computeLateFee(baseFee, monthsOverdue, policy) {
    const table = policy.late_fee_table || {};
    const key = String(Math.max(1, Math.min(monthsOverdue, 6)));
    const rate = table[key];
    if (!rate) return 0;
    return applyRounding(baseFee * rate, policy);
}

function computeRecoverySurcharge(baseFee, policy) {
    const rp = policy.recovery_policy || { type: "none" };
    if (rp.type === "multiplier") {
        const mult = rp.value || 1.0;
        const extra = baseFee * (mult - 1.0);
        return applyRounding(extra, policy);
    }
    return 0;
}

// ì—°ì°¨ìˆ˜ ê³„ì‚° (ë“±ë¡ì¼ë¶€í„° ê³„ì‚°)
function calculateAnnualYear(registrationDate, currentDate) {
    const regDate = new Date(registrationDate);
    const today = new Date(currentDate);
    const yearDiff = today.getFullYear() - regDate.getFullYear();
    const monthDiff = today.getMonth() - regDate.getMonth();
    const dayDiff = today.getDate() - regDate.getDate();
    
    let annualYear = yearDiff;
    if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
        annualYear--;
    }
    
    return Math.max(1, annualYear + 1); // ë“±ë¡ ë‹¤ìŒ ë…„ë„ë¶€í„° 1ë…„ì°¨
}

// ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼ ê³„ì‚° (ë“±ë¡ì¼ ê¸°ì¤€ìœ¼ë¡œ ë§¤ë…„)
function calculateDueDate(registrationDate, annualYear) {
    const regDate = new Date(registrationDate);
    const dueDate = new Date(regDate);
    dueDate.setFullYear(regDate.getFullYear() + annualYear);
    return dueDate;
}

// ì—°ì°¨ë£Œ ê³„ì‚° ë©”ì¸ í•¨ìˆ˜
function calculateAnnuityFees() {
    if (currentPatents.length === 0) {
        showError('ê³„ì‚°í•  íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    const today = new Date();
    const tableBody = document.getElementById('patentTableBody');
    const rows = tableBody.getElementsByTagName('tr');
    
    currentPatents.forEach((patent, index) => {
        if (index >= rows.length) return;
        
        const row = rows[index];
        const cells = row.getElementsByTagName('td');
        
        // ë“±ë¡ì¼ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ê³„ì‚°
        if (patent.registrationDate && patent.registrationDate !== '-') {
            const registrationDate = new Date(patent.registrationDate);
            const annualYear = calculateAnnualYear(patent.registrationDate, today);
            
            // ì—°ì°¨ìˆ˜ê°€ 20ë…„ì„ ì´ˆê³¼í•˜ë©´ íŠ¹í—ˆ ë§Œë£Œ
            if (annualYear > 20) {
                cells[10].textContent = '-'; // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
                cells[11].textContent = 'ë§Œë£Œ'; // í•´ë‹¹ì—°ì°¨ìˆ˜
                cells[12].textContent = '-'; // í•´ë‹¹ì—°ì°¨ë£Œ
                cells[13].textContent = 'ë§Œë£Œ'; // ìœ íš¨/ë¶ˆë‚©
                cells[14].textContent = '-'; // ì°¨ê¸°ë…„ë„ ë‚©ë¶€ì˜ë¢°
                cells[15].textContent = '-'; // ì¶”ë‚©ê¸°ê°„
                cells[16].textContent = '-'; // íšŒë³µê¸°ê°„
                return;
            }
            
            const dueDate = calculateDueDate(patent.registrationDate, annualYear);
            const baseFee = KIPO_ANNUITY_FEES[annualYear] || 0;
            const status = computeStatus(dueDate, today, ANNUITY_POLICY);
            
            let totalFee = baseFee;
            let lateFee = 0;
            let recoverySurcharge = 0;
            
            // ìƒíƒœì— ë”°ë¥¸ ì¶”ê°€ ë¹„ìš© ê³„ì‚°
            if (status === "ì¶”ë‚©ê¸°ê°„") {
                const monthsOverdue = wholeMonthsOverdue(dueDate, today);
                lateFee = computeLateFee(baseFee, monthsOverdue, ANNUITY_POLICY);
                totalFee = baseFee + lateFee;
            } else if (status === "íšŒë³µê¸°ê°„") {
                recoverySurcharge = computeRecoverySurcharge(baseFee, ANNUITY_POLICY);
                totalFee = baseFee + recoverySurcharge;
            }
            
            // ê¸°ê°„ ê³„ì‚°
            const graceEnd = endOfMonthSafeAddMonths(dueDate, ANNUITY_POLICY.grace_months);
            const recoveryEnd = endOfMonthSafeAddMonths(graceEnd, ANNUITY_POLICY.recovery_months);
            
            // ê²°ê³¼ í‘œì‹œ
            cells[10].textContent = formatDate(dueDate.toISOString().split('T')[0]); // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
            cells[11].textContent = annualYear + 'ë…„ì°¨'; // í•´ë‹¹ì—°ì°¨ìˆ˜
            cells[12].textContent = totalFee.toLocaleString() + 'ì›'; // í•´ë‹¹ì—°ì°¨ë£Œ
            cells[13].textContent = status; // ìœ íš¨/ë¶ˆë‚©
            
            // ì°¨ê¸°ë…„ë„ ë‚©ë¶€ì˜ë¢° (í˜„ì¬ ì—°ì°¨ê°€ ìœ íš¨í•˜ê³  ë‹¤ìŒ ì—°ì°¨ê°€ 20ë…„ ì´ë‚´ì¸ ê²½ìš°)
            const nextYear = annualYear + 1;
            if (status === "ìœ íš¨" && nextYear <= 20) {
                const nextDueDate = calculateDueDate(patent.registrationDate, nextYear);
                const nextFee = KIPO_ANNUITY_FEES[nextYear] || 0;
                cells[14].textContent = `${nextYear}ë…„ì°¨ ${nextFee.toLocaleString()}ì› (${formatDate(nextDueDate.toISOString().split('T')[0])} ë§ˆê°)`;
            } else {
                cells[14].textContent = '-';
            }
            
            // ì¶”ë‚©ê¸°ê°„
            if (status === "ìœ íš¨") {
                cells[15].textContent = `${formatDate(dueDate.toISOString().split('T')[0])} ~ ${formatDate(graceEnd.toISOString().split('T')[0])}`;
            } else if (status === "ì¶”ë‚©ê¸°ê°„") {
                cells[15].textContent = `ì§„í–‰ì¤‘ (${formatDate(graceEnd.toISOString().split('T')[0])} ë§ˆê°)`;
            } else {
                cells[15].textContent = '-';
            }
            
            // íšŒë³µê¸°ê°„
            if (status === "ìœ íš¨" || status === "ì¶”ë‚©ê¸°ê°„") {
                cells[16].textContent = `${formatDate(graceEnd.toISOString().split('T')[0])} ~ ${formatDate(recoveryEnd.toISOString().split('T')[0])}`;
            } else if (status === "íšŒë³µê¸°ê°„") {
                cells[16].textContent = `ì§„í–‰ì¤‘ (${formatDate(recoveryEnd.toISOString().split('T')[0])} ë§ˆê°)`;
            } else {
                cells[16].textContent = '-';
            }
        } else {
            // ë“±ë¡ì¼ì´ ì—†ëŠ” ê²½ìš°
            cells[10].textContent = '-';
            cells[11].textContent = '-';
            cells[12].textContent = '-';
            cells[13].textContent = '-';
            cells[14].textContent = '-';
            cells[15].textContent = '-';
            cells[16].textContent = '-';
        }
    });
    
    // ê³„ì‚° ì™„ë£Œ ë©”ì‹œì§€
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.textContent = 'ì—°ì°¨ë£Œ ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
    successDiv.style.cssText = 'background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; text-align: center;';
    
    const resultsSection = document.getElementById('resultsSection');
    const existingSuccess = document.querySelector('.success-message');
    if (existingSuccess) {
        existingSuccess.remove();
    }
    resultsSection.insertBefore(successDiv, resultsSection.firstChild);
    
    // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.remove();
        }
    }, 3000);
}

// ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢°
function requestRenewalFee() {
    console.log('ğŸ¯ ë‚©ë¶€ì˜ë¢° ë²„íŠ¼ í´ë¦­ë¨ - ìƒˆ ë²„ì „ ì‹¤í–‰ ì¤‘');
    
    if (currentPatents.length === 0) {
        showError('ë‚©ë¶€ì˜ë¢°í•  íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ê³ ê°ë²ˆí˜¸ì™€ ì²« ë²ˆì§¸ ì¶œì›ì¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const customerNumber = document.getElementById('resultCustomerNumber').textContent;
    const applicantName = document.getElementById('resultApplicantName').textContent;
    
    console.log('ê³ ê°ì •ë³´:', { customerNumber, applicantName });
    
    showRenewalRequestModal(customerNumber, applicantName);
}

// ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢° ëª¨ë‹¬ í‘œì‹œ
function showRenewalRequestModal(customerNumber, applicantName) {
    // ëª¨ë‹¬ HTML ìƒì„±
    const modalHTML = `
        <div id="renewalModal" class="modal-overlay" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        ">
            <div class="modal-content" style="
                background: white;
                border-radius: 8px;
                padding: 2rem;
                width: 90%;
                max-width: 600px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            ">
                <div class="modal-header" style="
                    border-bottom: 2px solid #54B435;
                    padding-bottom: 1rem;
                    margin-bottom: 1.5rem;
                ">
                    <h2 style="
                        color: #0F172A;
                        font-size: 1.5rem;
                        font-weight: 700;
                        margin: 0;
                        text-align: center;
                    ">ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢°</h2>
                </div>
                
                <div class="guidance-text" style="
                    background: #f0fdf4;
                    padding: 1.5rem;
                    border-radius: 6px;
                    margin-bottom: 1.5rem;
                    border-left: 4px solid #54B435;
                ">
                    <h3 style="
                        color: #065f46;
                        font-size: 1.1rem;
                        font-weight: 600;
                        margin: 0 0 1rem 0;
                    ">ì•ˆë‚´ì‚¬í•­</h3>
                    <div style="color: #047857; line-height: 1.6;">
                        <p style="margin: 0 0 0.5rem 0;">1. ì—°ì°¨ë£Œ ë‚©ë¶€ë¥¼ ëŒ€í–‰í•´ ë“œë¦½ë‹ˆë‹¤</p>
                        <p style="margin: 0 0 1rem 0;">2. ëŒ€ë¦¬ì¸ ìˆ˜ìˆ˜ë£ŒëŠ” ê±´ë‹¹ 20,000ì›ì…ë‹ˆë‹¤ (ë¶€ê°€ì„¸ ë³„ë„)</p>
                        <p style="margin: 0 0 0.3rem 0; font-size: 0.9rem; color: #059669;">
                            - ê°œì¸, ì¤‘ì†Œê¸°ì—… 70% ê°ë©´ ê¸ˆì•¡ í™•ì¸í•˜ì—¬ ì—°ì°¨ë£Œ ë¹„ìš© ì²­êµ¬ì„œ ë°œì†¡
                        </p>
                        <p style="margin: 0; font-size: 0.9rem; color: #059669;">
                            - ì„¸ê¸ˆ ê³„ì‚°ì„œì™€ ì˜ìˆ˜ì¦ ì†¡ë¶€
                        </p>
                    </div>
                </div>
                
                <form action="https://api.web3forms.com/submit" method="POST" id="renewalRequestForm">
                    <input type="hidden" name="access_key" value="dd3c9ad5-1802-4bd1-b7e6-397002308afa">
                    <input type="hidden" name="redirect" value="https://unicpat.com/thanks">
                    <input type="hidden" name="subject" value="ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢°">
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: #374151;
                            font-weight: 500;
                            margin-bottom: 0.5rem;
                        ">ê³ ê°ë²ˆí˜¸</label>
                        <input type="text" name="customer_number" value="${customerNumber}" readonly style="
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid #d1d5db;
                            border-radius: 4px;
                            background: #f9fafb;
                            color: #6b7280;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: #374151;
                            font-weight: 500;
                            margin-bottom: 0.5rem;
                        ">ì´ë¦„</label>
                        <input type="text" name="name" value="${applicantName}" readonly style="
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid #d1d5db;
                            border-radius: 4px;
                            background: #f9fafb;
                            color: #6b7280;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="
                            display: block;
                            color: #374151;
                            font-weight: 500;
                            margin-bottom: 0.5rem;
                        ">ì´ë©”ì¼ <span style="color: #ef4444;">*</span></label>
                        <input type="email" name="email" required style="
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid #d1d5db;
                            border-radius: 4px;
                            outline: none;
                        " placeholder="example@email.com">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="
                            display: block;
                            color: #374151;
                            font-weight: 500;
                            margin-bottom: 0.5rem;
                        ">ì—°ë½ì²˜ <span style="color: #ef4444;">*</span></label>
                        <input type="tel" name="phone" required style="
                            width: 100%;
                            padding: 0.75rem;
                            border: 1px solid #d1d5db;
                            border-radius: 4px;
                            outline: none;
                        " placeholder="010-0000-0000">
                    </div>
                    
                    <!-- ìˆ¨ê²¨ì§„ ë©”ì‹œì§€ í•„ë“œ (ì´ë©”ì¼ ë³¸ë¬¸ìš©) -->
                    <textarea name="message" style="display: none;">
ìƒˆë¡œìš´ ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢°ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.

â–  ê³ ê° ì •ë³´
- ê³ ê°ë²ˆí˜¸: ${customerNumber}
- ì´ë¦„: ${applicantName}
- ì´ë©”ì¼: (ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì´ë©”ì¼)
- ì—°ë½ì²˜: (ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì—°ë½ì²˜)

â–  ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜
- ë™ì˜ ì—¬ë¶€: ë™ì˜í•¨
- ë™ì˜ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

â–  ì²˜ë¦¬ ìš”ì²­ì‚¬í•­
ì—°ì°¨ë£Œ ë‚©ë¶€ ëŒ€í–‰ ì„œë¹„ìŠ¤ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
ëŒ€ë¦¬ì¸ ìˆ˜ìˆ˜ë£Œ: ê±´ë‹¹ 20,000ì› (ë¶€ê°€ì„¸ ë³„ë„)

ë‹´ë‹¹ìëŠ” ê³ ê°ì—ê²Œ ì—°ë½í•˜ì—¬ ìƒì„¸ ì‚¬í•­ì„ ì•ˆë‚´í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                    </textarea>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="
                            display: block;
                            color: #374151;
                            font-weight: 500;
                            margin-bottom: 0.5rem;
                        ">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜ <span style="color: #ef4444;">*</span></label>
                        <div style="
                            border: 1px solid #d1d5db;
                            border-radius: 4px;
                            background: #f9fafb;
                            padding: 1rem;
                            font-size: 0.9rem;
                            color: #6b7280;
                            line-height: 1.5;
                        ">
                            <p style="margin: 0 0 0.5rem 0;">ìˆ˜ì§‘Â·ì´ìš© ëª©ì  - ì—°ì°¨ë£Œ ë‚©ë¶€ ëŒ€í–‰ ì²˜ë¦¬</p>
                            <p style="margin: 0 0 0.5rem 0;">ìˆ˜ì§‘ í•­ëª© - íŠ¹í—ˆ ê³ ê°ë²ˆí˜¸, ì´ë¦„, ì—°ë½ì²˜, ì´ë©”ì¼</p>
                            <p style="margin: 0;">ë³´ìœ  ë° ì´ìš© ê¸°ê°„ - ë‚©ë¶€ë£Œ ëŒ€í–‰ì²˜ë¦¬ ì™„ë£Œ ì‹œ</p>
                        </div>
                        <div style="margin-top: 0.75rem; display: flex; align-items: center;">
                            <input type="checkbox" name="privacy_consent" required style="
                                margin-right: 0.5rem;
                                width: 16px;
                                height: 16px;
                            ">
                            <label style="
                                color: #374151;
                                font-size: 0.9rem;
                            ">ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.</label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" onclick="closeRenewalModal()" style="
                            padding: 0.75rem 1.5rem;
                            border: 1px solid #d1d5db;
                            background: white;
                            color: #374151;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 500;
                        ">ì·¨ì†Œ</button>
                        <button type="submit" style="
                            padding: 0.75rem 1.5rem;
                            background: #54B435;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: 500;
                        ">ë‚©ë¶€ì˜ë¢°</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    // ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // í¼ ì œì¶œ ì „ ë©”ì‹œì§€ í•„ë“œ ì—…ë°ì´íŠ¸
    document.getElementById('renewalRequestForm').addEventListener('submit', function(e) {
        const emailInput = this.querySelector('input[name="email"]');
        const phoneInput = this.querySelector('input[name="phone"]');
        const messageTextarea = this.querySelector('textarea[name="message"]');
        
        // ë™ì ìœ¼ë¡œ ë©”ì‹œì§€ ë‚´ìš© ì—…ë°ì´íŠ¸
        const updatedMessage = `ìƒˆë¡œìš´ ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢°ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.

â–  ê³ ê° ì •ë³´
- ê³ ê°ë²ˆí˜¸: ${customerNumber}
- ì´ë¦„: ${applicantName}
- ì´ë©”ì¼: ${emailInput.value}
- ì—°ë½ì²˜: ${phoneInput.value}

â–  ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜
- ë™ì˜ ì—¬ë¶€: ë™ì˜í•¨
- ë™ì˜ ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

â–  ì²˜ë¦¬ ìš”ì²­ì‚¬í•­
ì—°ì°¨ë£Œ ë‚©ë¶€ ëŒ€í–‰ ì„œë¹„ìŠ¤ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.
ëŒ€ë¦¬ì¸ ìˆ˜ìˆ˜ë£Œ: ê±´ë‹¹ 20,000ì› (ë¶€ê°€ì„¸ ë³„ë„)

ë‹´ë‹¹ìëŠ” ê³ ê°ì—ê²Œ ì—°ë½í•˜ì—¬ ìƒì„¸ ì‚¬í•­ì„ ì•ˆë‚´í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`;
        
        messageTextarea.value = updatedMessage;
        
        console.log('ğŸ’Œ ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢° í¼ ì œì¶œ ì¤‘...');
    });
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('renewalModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeRenewalModal();
        }
    });
}

// ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢° ëª¨ë‹¬ ë‹«ê¸°
function closeRenewalModal() {
    const modal = document.getElementById('renewalModal');
    if (modal) {
        modal.remove();
    }
}

// í¼ ì œì¶œ í›„ ëª¨ë‹¬ ë‹«ê¸° (ì„±ê³µ ì‹œ Web3Formsê°€ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì²˜ë¦¬)
function handleFormSubmitSuccess() {
    // Web3Formsê°€ ì„±ê³µ ì‹œ redirect ì²˜ë¦¬í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
    console.log('ğŸ’Œ ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢° í¼ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// Event listeners for buttons (avoiding CSP issues with inline onclick)
document.addEventListener('DOMContentLoaded', function() {
    // Annuity calculation button
    const calculateBtn = document.getElementById('calculateAnnuityBtn');
    if (calculateBtn) {
        calculateBtn.addEventListener('click', calculateAnnuityFees);
    }
    
    // Renewal request button
    const renewalBtn = document.getElementById('renewalRequestBtn');
    if (renewalBtn) {
        renewalBtn.addEventListener('click', requestRenewalFee);
    }
    
    // Export button
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportToExcel);
    }
});
</script>