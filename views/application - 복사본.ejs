<%- include('partials/header') %>

<main class="main-content">
    <div class="container">
        <div class="page-title">
            <h1>ì¶œì›íŠ¹í—ˆ í˜„í™©</h1>
            <p>ê³ ê°ë²ˆí˜¸ë¡œ ì¶œì› ì¤‘ì¸ íŠ¹í—ˆ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤</p>
        </div>

        <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="customerNumber" class="form-label">ê³ ê°ë²ˆí˜¸</label>
                    <input 
                        type="text" 
                        id="customerNumber" 
                        name="customerNumber" 
                        class="form-input"
                        placeholder="ì˜ˆ: 120190612244"
                        maxlength="12"
                        pattern="[0-9]{12}"
                        required
                    >
                    <div class="form-hint">12ìë¦¬ ìˆ«ì ì…ë ¥í•˜ì„¸ìš”</div>
                </div>
                <button type="submit" class="btn btn-primary" id="searchBtn">
                    ğŸ” ê²€ìƒ‰í•˜ê¸°
                </button>
            </form>
        </section>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <section class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-info">
                    <div class="info-item">
                        <span class="info-label">ê³ ê°ë²ˆí˜¸:</span>
                        <span class="info-value" id="resultCustomerNumber">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì¶œì›ì¸:</span>
                        <span class="info-value" id="resultApplicantName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì¶œì›íŠ¹í—ˆ ìˆ˜:</span>
                        <span class="info-value" id="resultTotalCount">0</span>ê±´
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" id="exportBtn">
                        ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="patent-table" id="patentTable">
                    <thead>
                        <tr>
                            <th>ì¶œì›ë²ˆí˜¸</th>
                            <th>ë“±ë¡ë²ˆí˜¸</th>
                            <th>ì¶œì›ì¸</th>
                            <th>ë°œëª…ì</th>
                            <th>ì¶œì›ì¼</th>
                            <th>ìš°ì„ ê¶Œ ì¶œì›ë²ˆí˜¸</th>
                            <th>PCTë§ˆê°ì¼</th>
                            <th>ë°œëª…ì˜ ëª…ì¹­</th>
                            <th>ì˜ê²¬í†µì§€ì„œ</th>
                            <th>í˜„ì¬ìƒíƒœ</th>
                            <th>ê³µê°œì „ë¬¸</th>
                            <th>ê³µê³ ì „ë¬¸</th>
                            <th>PCTì¶œì›ë²ˆí˜¸</th>
                            <th>FamilyíŠ¹í—ˆë²ˆí˜¸</th>
                            <th>ì—°ì°¨ë£Œë‚©ë¶€</th>
                        </tr>
                    </thead>
                    <tbody id="patentTableBody">
                        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“„</div>
                <div class="empty-title">ì¶œì›íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="empty-description">í•´ë‹¹ ê³ ê°ë²ˆí˜¸ë¡œ ì¶œì› ì¤‘ì¸ íŠ¹í—ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </section>
    </div>
</main>

<%- include('partials/footer') %>

<script>
let currentPatents = [];

// í¼ ì œì¶œ ì´ë²¤íŠ¸
document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const customerNumber = document.getElementById('customerNumber').value.trim();
    const searchBtn = document.getElementById('searchBtn');
    const originalText = searchBtn.innerHTML;
    
    // ì…ë ¥ ê²€ì¦ (12ìë¦¬ ìˆ«ì)
    if (!/^\d{12}$/.test(customerNumber)) {
        showError('ê³ ê°ë²ˆí˜¸ëŠ” 12ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    hideError();
    showLoading(searchBtn);
    
    try {
        const response = await fetch('/api/search-application', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ customerNumber })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
        
        displayResults(data);
        
    } catch (error) {
        console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        showError(error.message);
        hideResults();
    } finally {
        hideLoading(searchBtn, originalText);
    }
});

// ê²°ê³¼ í‘œì‹œ
function displayResults(data) {
    currentPatents = data.patents || [];
    
    
    document.getElementById('resultCustomerNumber').textContent = data.customerNumber;
    document.getElementById('resultApplicantName').textContent = data.applicantName;
    document.getElementById('resultTotalCount').textContent = data.totalCount;
    
    const tableBody = document.getElementById('patentTableBody');
    const emptyState = document.getElementById('emptyState');
    const resultsSection = document.getElementById('resultsSection');
    
    tableBody.innerHTML = '';
    
    if (currentPatents.length === 0) {
        emptyState.style.display = 'block';
        document.querySelector('.table-container').style.display = 'none';
    } else {
        emptyState.style.display = 'none';
        document.querySelector('.table-container').style.display = 'block';
        
        currentPatents.forEach(patent => {
            const row = document.createElement('tr');
            const statusBadge = getStatusBadge(patent.examStatus);
            const progressBadge = getProgressBadge(patent.registrationStatus);
            
            row.innerHTML = `
                <td>${patent.applicationNumber}</td>
                <td>${patent.registrationNumber || '-'}</td>
                <td>${patent.applicantName}</td>
                <td>${patent.inventorName}</td>
                <td>${formatDate(patent.applicationDate)}</td>
                <td>${patent.priorityNumber || '-'}</td>
                <td>${formatDate(patent.pctDeadline) || '-'}</td>
                <td style="max-width: 300px; word-break: break-word;">${patent.inventionTitle}</td>
                <td>${patent.opinionNotice || '-'}</td>
                <td>${patent.currentStatus || 'ì‹¬ì‚¬ì¤‘'}</td>
                <td>${createFileLink(patent.publicationFullText, patent.publicationDocName, 'ê³µê°œì „ë¬¸')}</td>
                <td>${createFileLink(patent.announcementFullText, patent.announcementDocName, 'ê³µê³ ì „ë¬¸')}</td>
                <td>${patent.pctApplicationNumber || '-'}</td>
                <td>${patent.familyPatentNumber || '-'}</td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    resultsSection.style.display = 'block';
}

// ì‹¬ì‚¬ìƒíƒœ ë°°ì§€
function getStatusBadge(status) {
    if (!status || status === '-') return '-';
    
    let badgeClass = 'badge-info';
    if (status.includes('ë“±ë¡')) badgeClass = 'badge-success';
    else if (status.includes('ê±°ì ˆ')) badgeClass = 'badge-warning';
    
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

// ì§„í–‰ìƒíƒœ ë°°ì§€
function getProgressBadge(status) {
    if (!status || status === '-') return '-';
    
    let badgeClass = 'badge-warning';
    if (status === 'ë“±ë¡') badgeClass = 'badge-success';
    
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

// ê²°ê³¼ ìˆ¨ê¸°ê¸°
function hideResults() {
    document.getElementById('resultsSection').style.display = 'none';
}

// íŒŒì¼ ë§í¬ ìƒì„± í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
function createFileLink(filePath, docName, linkText) {
    // íŒŒì¼ ê²½ë¡œê°€ ì—†ê±°ë‚˜ ê¸°ë³¸ê°’ì¸ ê²½ìš°
    if (!filePath || filePath === '-' || filePath.trim() === '') {
        return `<span class="no-file">-</span>`;
    }
    
    // URLì´ ìœ íš¨í•œì§€ í™•ì¸
    try {
        const url = new URL(filePath);
        const displayName = docName && docName !== '-' ? docName : linkText;
        
        return `<a href="${filePath}" target="_blank" class="file-link" title="${displayName}">
                    <span class="file-icon">ğŸ“„</span> ${linkText}
                </a>`;
    } catch (e) {
        // URLì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°
        console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ íŒŒì¼ URL:', filePath);
        return `<span class="invalid-file" title="íŒŒì¼ URLì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤">âŒ ${linkText}</span>`;
    }
}

// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function exportToExcel() {
    if (currentPatents.length === 0) {
        showError('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    downloadExcel(currentPatents, 'application');
}

// Event listeners setup (avoiding CSP issues with inline onclick)
document.addEventListener('DOMContentLoaded', function() {
    // Export button
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportToExcel);
    }
});
</script>