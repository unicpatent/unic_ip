<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title><%= title %> - ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ íŠ¹í—ˆ í˜„í™© ì¡°íšŒ ì‹œìŠ¤í…œ">
    <meta name="keywords" content="íŠ¹í—ˆ, íŠ¹í—ˆì‚¬ë¬´ì†Œ, íŠ¹í—ˆ í˜„í™©, ë“±ë¡íŠ¹í—ˆ, ì¶œì›íŠ¹í—ˆ, ìœ ë‹ˆí¬">
    <meta name="author" content="ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="<%= title %> - ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ">
    <meta property="og:description" content="ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ íŠ¹í—ˆ í˜„í™© ì¡°íšŒ ì‹œìŠ¤í…œ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://unicpat.com">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="/css/ejs-style.css">
    <link rel="stylesheet" href="/css/annual-fee-status.css">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="alternate icon" href="/images/favicon.svg">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">
                    ìœ ë‹ˆí¬<span>íŠ¹í—ˆ</span>
                </a>
                <nav class="nav-tabs">
                    <a href="/registered" class="nav-link">ë“±ë¡íŠ¹í—ˆ í˜„í™©</a>
                    <a href="/application" class="nav-link">ì¶œì›íŠ¹í—ˆ í˜„í™©</a>
                </nav>
            </div>
        </div>
    </header>

<main class="main-content">
    <div class="container">
        <div class="page-title">
            <h1>ì¶œì›íŠ¹í—ˆ í˜„í™©</h1>
            <p>ê³ ê°ë²ˆí˜¸ë¡œ ì¶œì› ì¤‘ì¸ íŠ¹í—ˆ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤</p>
        </div>

        <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="customerNumber" class="form-label">ê³ ê°ë²ˆí˜¸</label>
                    <div class="input-group">
                        <input
                            type="text"
                            id="customerNumber"
                            name="customerNumber"
                            class="form-input customer-number-input"
                            placeholder="ì˜ˆ: 120190612244"
                            maxlength="12"
                            pattern="[0-9]{12}"
                            required
                        >
                        <button type="submit" class="btn btn-primary" id="searchBtn">
                            ğŸ” ê²€ìƒ‰í•˜ê¸°
                        </button>
                    </div>
                    <div class="form-hint">12ìë¦¬ ìˆ«ì ì…ë ¥í•˜ì„¸ìš”</div>
                </div>
                <button type="button" class="btn btn-secondary find-customer-btn" id="findCustomerBtn">
                    ê³ ê°ë²ˆí˜¸ ì°¾ê¸°
                </button>
            </form>
        </section>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <section class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-info">
                    <div class="info-item">
                        <span class="info-label">ê³ ê°ë²ˆí˜¸:</span>
                        <span class="info-value" id="resultCustomerNumber">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì¶œì›ì¸:</span>
                        <span class="info-value" id="resultApplicantName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ì¶œì›íŠ¹í—ˆ ìˆ˜:</span>
                        <span class="info-value" id="resultTotalCount">0</span>ê±´
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-primary" id="pctRequestBtn">
                        ğŸŒ PCT ë‚©ë¶€ì˜ë¢°
                    </button>
                    <button type="button" class="btn btn-secondary" id="exportBtn">
                        ğŸ“Š ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="patent-table" id="patentTable">
                    <thead>
                        <tr>
                            <th>ì¶œì›ë²ˆí˜¸</th>
                            <th>ë“±ë¡ë²ˆí˜¸</th>
                            <th>ì¶œì›ì¸</th>
                            <th>ë°œëª…ì</th>
                            <th>ì¶œì›ì¼</th>
                            <th>ìš°ì„ ì¼</th>
                            <th>PCTë§ˆê°ì¼</th>
                            <th>ë°œëª…ì˜ ëª…ì¹­</th>
                            <th>í˜„ì¬ìƒíƒœ</th>
                            <th>ê³µê°œì „ë¬¸</th>
                            <th>ê³µê³ ì „ë¬¸</th>
                        </tr>
                    </thead>
                    <tbody id="patentTableBody">
                        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“„</div>
                <div class="empty-title">ì¶œì›íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="empty-description">í•´ë‹¹ ê³ ê°ë²ˆí˜¸ë¡œ ì¶œì› ì¤‘ì¸ íŠ¹í—ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </section>
    </div>
</main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-text">
                    <strong>ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ</strong> - íŠ¹í—ˆ í˜„í™© ì¡°íšŒ ì‹œìŠ¤í…œ
                </div>
                <div class="footer-contact">
                    <a href="tel:010-3131-7960">ğŸ“ 010-3131-7960</a>
                    <a href="mailto:ljunhyek@naver.com">âœ‰ï¸ ljunhyek@naver.com</a>
                    <a href="https://unicpat.com" target="_blank">ğŸŒ unicpat.com</a>
                </div>
                <div class="footer-text" style="margin-top: 1rem; font-size: 0.875rem; color: #94a3b8;">
                    Â© 2024 ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ. All rights reserved.
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="/js/main.js"></script>
</body>
</html>

<script>
let currentPatents = [];
let currentPage = 1;
const itemsPerPage = 5;

// í¼ ì œì¶œ ì´ë²¤íŠ¸
document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const customerNumber = document.getElementById('customerNumber').value.trim();
    const searchBtn = document.getElementById('searchBtn');
    const originalText = searchBtn.innerHTML;
    
    // ì…ë ¥ ê²€ì¦ (12ìë¦¬ ìˆ«ì)
    if (!/^\d{12}$/.test(customerNumber)) {
        showError('ê³ ê°ë²ˆí˜¸ëŠ” 12ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    hideError();
    showLoading(searchBtn);
    
    try {
        const response = await fetch('/api/search-application', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ customerNumber })
        });
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
        
        displayResults(data);
        
    } catch (error) {
        console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
        showError(error.message);
        hideResults();
    } finally {
        hideLoading(searchBtn, originalText);
    }
});

// ê²°ê³¼ í‘œì‹œ
function displayResults(data) {
    currentPatents = data.patents || [];
    currentPage = 1; // ê²€ìƒ‰ ì‹œ ì²« í˜ì´ì§€ë¡œ ì´ˆê¸°í™”
    
    document.getElementById('resultCustomerNumber').textContent = data.customerNumber;
    document.getElementById('resultApplicantName').textContent = data.applicantName;
    document.getElementById('resultTotalCount').textContent = data.totalCount;
    
    const resultsSection = document.getElementById('resultsSection');
    
    if (currentPatents.length === 0) {
        document.getElementById('emptyState').style.display = 'block';
        document.querySelector('.table-container').style.display = 'none';
    } else {
        document.getElementById('emptyState').style.display = 'none';
        document.querySelector('.table-container').style.display = 'block';
        displayPaginatedResults();
    }
    
    resultsSection.style.display = 'block';
}

// í˜ì´ì§€ë„¤ì´ì…˜ëœ ê²°ê³¼ í‘œì‹œ
function displayPaginatedResults() {
    const tableBody = document.getElementById('patentTableBody');
    const totalPages = Math.ceil(currentPatents.length / itemsPerPage);
    
    // í…Œì´ë¸” ì´ˆê¸°í™”
    tableBody.innerHTML = '';
    
    // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„° ê³„ì‚°
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, currentPatents.length);
    const paginatedPatents = currentPatents.slice(startIndex, endIndex);
    
    console.log('ğŸ“Š í˜ì´ì§€ë„¤ì´ì…˜ ë°ì´í„° ìƒì„± ì¤‘...', `${currentPage}/${totalPages} í˜ì´ì§€, ${paginatedPatents.length}ê±´`);
    
    paginatedPatents.forEach((patent, index) => {
        const row = document.createElement('tr');
        
        // ì•ˆì „í•œ ë¬¸ìì—´ ì²˜ë¦¬
        const safeValue = (value) => value && value !== '-' ? value : '-';
        
        const applicantName = safeValue(patent.applicantName);
        const inventionTitle = safeValue(patent.inventionTitle);
        
        row.innerHTML = `
            <td class="patent-number">${safeValue(patent.applicationNumber)}</td>
            <td class="patent-number">${safeValue(patent.registrationNumber)}</td>
            <td class="applicant-name-clean applicant-name">${applicantName}</td>
            <td>${safeValue(patent.inventorName)}</td>
            <td>${formatDate(patent.applicationDate)}</td>
            <td>${safeValue(patent.priorityApplicationDate)}</td>
            <td>${formatDate(patent.pctDeadline) || '-'}</td>
            <td class="invention-title-natural invention-title">${inventionTitle}</td>
            <td>${safeValue(patent.currentStatus) || 'ì‹¬ì‚¬ì¤‘'}</td>
            <td>${createFileLink(patent.publicationFullText, patent.publicationDocName, 'ê³µê°œì „ë¬¸')}</td>
            <td>${createFileLink(patent.announcementFullText, patent.announcementDocName, 'ê³µê³ ì „ë¬¸')}</td>
        `;
        tableBody.appendChild(row);
    });
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ìƒì„±/ì—…ë°ì´íŠ¸
    createPaginationControls(totalPages);
    
    console.log('âœ… í˜ì´ì§€ë„¤ì´ì…˜ í…Œì´ë¸” ìƒì„± ì™„ë£Œ:', `${currentPage}/${totalPages} í˜ì´ì§€, ${paginatedPatents.length}ê±´`);
}

// í˜ì´ì§€ë„¤ì´ì…˜ ì»¨íŠ¸ë¡¤ ìƒì„±
function createPaginationControls(totalPages) {
    let paginationContainer = document.getElementById('paginationContainer');
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ìƒì„±
    if (!paginationContainer) {
        paginationContainer = document.createElement('div');
        paginationContainer.id = 'paginationContainer';
        paginationContainer.className = 'pagination-container';
        
        // í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ë‹¤ìŒì— ì‚½ì…
        const tableContainer = document.querySelector('.table-container');
        tableContainer.parentNode.insertBefore(paginationContainer, tableContainer.nextSibling);
    }
    
    // í˜ì´ì§€ê°€ 1ê°œ ì´í•˜ë©´ ìˆ¨ê¹€
    if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
    }
    
    paginationContainer.style.display = 'flex';
    
    let paginationHTML = '<div class="pagination-info">ì´ ' + currentPatents.length + 'ê±´ (í˜ì´ì§€ ' + currentPage + '/' + totalPages + ')</div>';
    paginationHTML += '<div class="pagination-controls">';
    
    // ì´ì „ ë²„íŠ¼
    if (currentPage > 1) {
        paginationHTML += '<button class="pagination-btn" data-page="' + (currentPage - 1) + '">â€¹ ì´ì „</button>';
    } else {
        paginationHTML += '<button class="pagination-btn disabled">â€¹ ì´ì „</button>';
    }
    
    // í˜ì´ì§€ ë²ˆí˜¸ (ìµœëŒ€ 5ê°œ í‘œì‹œ)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            paginationHTML += '<button class="pagination-btn active">' + i + '</button>';
        } else {
            paginationHTML += '<button class="pagination-btn" data-page="' + i + '">' + i + '</button>';
        }
    }
    
    // ë‹¤ìŒ ë²„íŠ¼
    if (currentPage < totalPages) {
        paginationHTML += '<button class="pagination-btn" data-page="' + (currentPage + 1) + '">ë‹¤ìŒ â€º</button>';
    } else {
        paginationHTML += '<button class="pagination-btn disabled">ë‹¤ìŒ â€º</button>';
    }
    
    paginationHTML += '</div>';
    paginationContainer.innerHTML = paginationHTML;
    
    // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    const paginationBtns = paginationContainer.querySelectorAll('.pagination-btn[data-page]');
    paginationBtns.forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const targetPage = parseInt(this.getAttribute('data-page'));
            if (targetPage && targetPage !== currentPage) {
                changePage(targetPage);
            }
        });
    });
}

// í˜ì´ì§€ ë³€ê²½
function changePage(page) {
    if (page < 1 || page > Math.ceil(currentPatents.length / itemsPerPage)) return;
    
    currentPage = page;
    displayPaginatedResults();
    
    // í…Œì´ë¸” ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    document.querySelector('.table-container').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

// ì‹¬ì‚¬ìƒíƒœ ë°°ì§€
function getStatusBadge(status) {
    if (!status || status === '-') return '-';
    
    let badgeClass = 'badge-info';
    if (status.includes('ë“±ë¡')) badgeClass = 'badge-success';
    else if (status.includes('ê±°ì ˆ')) badgeClass = 'badge-warning';
    
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

// ì§„í–‰ìƒíƒœ ë°°ì§€
function getProgressBadge(status) {
    if (!status || status === '-') return '-';
    
    let badgeClass = 'badge-warning';
    if (status === 'ë“±ë¡') badgeClass = 'badge-success';
    
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

// ê²°ê³¼ ìˆ¨ê¸°ê¸°
function hideResults() {
    document.getElementById('resultsSection').style.display = 'none';
}

// íŒŒì¼ ë§í¬ ìƒì„± í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
function createFileLink(filePath, docName, linkText) {
    // íŒŒì¼ ê²½ë¡œê°€ ì—†ê±°ë‚˜ ê¸°ë³¸ê°’ì¸ ê²½ìš°
    if (!filePath || filePath === '-' || filePath.trim() === '') {
        return `<span class="no-file">-</span>`;
    }

    // URLì´ ìœ íš¨í•œì§€ í™•ì¸
    try {
        const url = new URL(filePath);
        const displayName = docName && docName !== '-' ? docName : linkText;

        return `<a href="${filePath}" target="_blank" class="file-link"
                   title="í´ë¦­: ìƒˆì°½ ì—´ê¸° | ë”ë¸”í´ë¦­: ë‹¤ìš´ë¡œë“œ"
                   ondblclick="downloadFile('${filePath}', '${displayName}'); event.preventDefault();">
                    <span class="file-icon">ğŸ“„</span> ${linkText}
                </a>`;
    } catch (e) {
        // URLì´ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ìš°
        console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ íŒŒì¼ URL:', filePath);
        return `<span class="invalid-file" title="íŒŒì¼ URLì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤">âŒ ${linkText}</span>`;
    }
}

// íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (í”„ë¡ì‹œ API ì‚¬ìš©)
async function downloadFile(fileUrl, fileName) {
    try {
        console.log('ğŸ“¥ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘:', { fileUrl, fileName });

        // ë¡œë”© í‘œì‹œ
        const originalTitle = document.title;
        document.title = 'ğŸ“¥ ë‹¤ìš´ë¡œë“œ ì¤‘...';

        // í”„ë¡ì‹œ APIë¥¼ í†µí•œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        const response = await fetch('/api/download-file', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                fileUrl: fileUrl,
                fileName: fileName || 'íŠ¹í—ˆë¬¸ì„œ.pdf'
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }

        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
        const blob = await response.blob();
        const downloadUrl = window.URL.createObjectURL(blob);

        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = fileName || 'íŠ¹í—ˆë¬¸ì„œ.pdf';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // URL ê°ì²´ í•´ì œ
        window.URL.revokeObjectURL(downloadUrl);

        // ì œëª© ë³µì›
        document.title = originalTitle;

        console.log('âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');

        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
        const successMsg = document.createElement('div');
        successMsg.style.cssText = `
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            background: #10b981; color: white; padding: 12px 20px;
            border-radius: 6px; font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        successMsg.textContent = 'âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ';
        document.body.appendChild(successMsg);

        setTimeout(() => {
            if (successMsg.parentNode) {
                successMsg.remove();
            }
        }, 3000);

    } catch (error) {
        console.error('âŒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);

        // ì œëª© ë³µì›
        document.title = document.title.replace('ğŸ“¥ ë‹¤ìš´ë¡œë“œ ì¤‘...', '');

        // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
        showError('íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}

// ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
function exportToExcel() {
    if (currentPatents.length === 0) {
        showError('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê³ ê°ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    const customerNumber = document.getElementById('customerNumber').value.trim();

    downloadExcel(currentPatents, 'application', customerNumber);
}

// PCT ë‚©ë¶€ì˜ë¢° í•¨ìˆ˜
function requestPCTFiling() {
    console.log('ğŸŒ PCT ë‚©ë¶€ì˜ë¢° ë²„íŠ¼ í´ë¦­');
    
    if (currentPatents.length === 0) {
        showError('PCT ë‚©ë¶€ì˜ë¢°í•  íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ê³ ê°ë²ˆí˜¸ì™€ ì²« ë²ˆì§¸ ì¶œì›ì¸ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const customerNumber = document.getElementById('resultCustomerNumber').textContent;
    const applicantName = document.getElementById('resultApplicantName').textContent;
    
    console.log('ê³ ê°ì •ë³´:', { customerNumber, applicantName });
    
    showPCTRequestModal(customerNumber, applicantName);
}

// PCT ë‚©ë¶€ì˜ë¢° ëª¨ë‹¬ í‘œì‹œ
function showPCTRequestModal(customerNumber, applicantName) {
    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë“±ë¡
    window.closePCTModal = function() {
        const modal = document.getElementById('pctModal');
        if (modal) {
            modal.remove();
        }
    };
    
    // PCT ì•ˆë‚´ë¬¸ í…ìŠ¤íŠ¸
    const pctGuidanceText = `
        <h3 style="color: #0F172A; font-size: 1.2rem; font-weight: 600; margin: 0 0 1rem 0;">PCT/í•´ì™¸ì¶œì›(ë§ˆê°ì¼) ì•ˆë‚´</h3>
        <div style="line-height: 1.6; color: #374151;">
            <p style="margin: 0 0 0.5rem 0;"><strong>ê¸°ê°„:</strong> êµ­ë‚´ ì¶œì›ì¼ ë˜ëŠ” ìš°ì„ ì¼ë¶€í„° 1ë…„ ì´ë‚´</p>
            <p style="margin: 0 0 0.5rem 0;"><strong>PCT í˜‘ì•½:</strong> 200ì—¬ê°œ êµ­ê°€ì— ëŒ€í•œ ì¶œì›ì˜ ì†Œê¸‰ ì¸ì • (í•´ì™¸ ì¶œì›ì„ ìœ„í•œ í•œêµ­ ì¶œì›ì¼ë¡œ ì†Œê¸‰)</p>
            <p style="margin: 0 0 0.5rem 0;"><strong>ì œì¶œ ìš”ê±´:</strong> PCT ì¶œì› ì´í›„, êµ­ë‚´ ì¶œì›ì¼ë¶€í„° 30ê°œì›” ì´ë‚´ì— í•´ì™¸ ê°êµ­ì— ë²ˆì—­í•˜ì—¬ ì œì¶œí•˜ì—¬ì•¼ í•¨</p>
            <p style="margin: 0 0 0.5rem 0;"><strong>ë²ˆì—­ë¬¸:</strong> ì›ì¹™ì ìœ¼ë¡œ ê°êµ­ ì–¸ì–´ë¡œ ë²ˆì—­ë¬¸ì„ ì œì¶œí•˜ì—¬ì•¼ í•˜ë©°, ê°êµ­ ëŒ€ë¦¬ì¸ì„ í†µí•˜ì—¬ ì œì¶œí•˜ì—¬ì•¼ í•˜ì§€ë§Œ, PCT ì¶œì›ì„ í†µí•´ ìš°ì„  2ë…„ 6ê°œì›” ì—°ì¥í•˜ì—¬ í•´ì™¸ ì¶œì›ì„ ì¤€ë¹„í•  ìˆ˜ ìˆìŒ</p>
            <p style="margin: 0 0 0.5rem 0;"><strong>ì†Œê¸‰ íš¨ê³¼:</strong> ë¯¸êµ­, ìœ ëŸ½, ì¤‘êµ­, ì¼ë³¸ ë“± ì£¼ìš”êµ­ ì¶œì›ì¼ì€ í•œêµ­ ì¶œì›ì¼ë¡œ ì†Œê¸‰ë¨</p>
            <p style="margin: 0 0 1rem 0;"><strong>ë¹„ìš©:</strong> ê´€ë‚©ë£Œ 2,070,000ì›, ëŒ€ë¦¬ì¸ ìˆ˜ìˆ˜ë£Œ 700,000ì›</p>
        </div>
    `;
    
    // ëª¨ë‹¬ HTML ìƒì„±
    const modalHTML = `
        <div id="pctModal" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
            <div class="modal-content" style="background: white; border-radius: 8px; padding: 2rem; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.15);">
                <div class="modal-header" style="border-bottom: 2px solid #3B82F6; padding-bottom: 1rem; margin-bottom: 1.5rem;">
                    <h2 style="color: #0F172A; font-size: 1.5rem; font-weight: 700; margin: 0; text-align: center;">PCT ì¶œì›ì˜ë¢°</h2>
                </div>
                
                <div class="guidance-text" style="background: #eff6ff; padding: 1.5rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #3B82F6;">
                    ${pctGuidanceText}
                </div>
                
                <form action="https://api.web3forms.com/submit" method="POST" id="pctRequestForm">
                    <input type="hidden" name="access_key" value="dd3c9ad5-1802-4bd1-b7e6-397002308afa">
                    <input type="hidden" name="redirect" value="${window.location.origin}/p_thanks">
                    <input type="hidden" name="subject" value="PCT ì¶œì›ì˜ë¢°">
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem;">ê³ ê°ë²ˆí˜¸</label>
                        <input type="text" name="customer_number" id="customer_number" value="${customerNumber}" readonly style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb; color: #6b7280;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem;">ì´ë¦„ (1ë²ˆì§¸ ëª©ë¡ ì¶œì›ì¸)</label>
                        <input type="text" name="name" id="applicant_name" value="${applicantName}" readonly style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb; color: #6b7280;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem;">ì´ë©”ì¼ <span style="color: #ef4444;">*</span></label>
                        <input type="email" name="email" id="email" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="example@email.com">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem;">ì—°ë½ì²˜ <span style="color: #ef4444;">*</span></label>
                        <input type="tel" name="phone" id="phone" required style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px;" placeholder="010-0000-0000">
                    </div>
                    
                    <textarea name="message" style="display: none;">PCT ì¶œì›ì˜ë¢° - ê³ ê°ë²ˆí˜¸: ${customerNumber}, ê³ ê°ëª…: ${applicantName}
                    
ìˆ˜ì‹ ì: ljunhyek@naver.com
ì œëª©: PCT ì¶œì›ì˜ë¢°</textarea>
                    <input type="hidden" name="to" value="ljunhyek@naver.com">
                    
                    <div style="margin-bottom: 1.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb; padding: 1rem; font-size: 0.9rem; color: #6b7280; line-height: 1.5;">
                        <p style="margin: 0 0 0.5rem 0;"><strong>ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜</strong></p>
                        <p style="margin: 0 0 0.5rem 0;">ìˆ˜ì§‘Â·ì´ìš© ëª©ì : PCT ì¶œì› ëŒ€í–‰ ì²˜ë¦¬</p>
                        <p style="margin: 0 0 0.5rem 0;">ìˆ˜ì§‘ í•­ëª©: íŠ¹í—ˆ ê³ ê°ë²ˆí˜¸, ì´ë¦„, ì—°ë½ì²˜, ì´ë©”ì¼</p>
                        <p style="margin: 0 0 0.75rem 0;">ë³´ìœ  ë° ì´ìš© ê¸°ê°„: PCT ì¶œì› ëŒ€í–‰ì²˜ë¦¬ ì™„ë£Œ ì‹œ</p>
                        <label style="display: flex; align-items: center; color: #374151; font-size: 0.9rem;">
                            <input type="checkbox" name="privacy_consent" id="privacy_consent" required style="margin-right: 0.5rem; width: 16px; height: 16px;">
                            ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.
                        </label>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" onclick="closePCTModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 4px; cursor: pointer; font-weight: 500;">ì·¨ì†Œ</button>
                        <button type="submit" style="padding: 0.75rem 1.5rem; background: #3B82F6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">PCT ì¶œì›ì˜ë¢°</button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    console.log('âœ… PCT ë‚©ë¶€ì˜ë¢° ëª¨ë‹¬ ìƒì„± ì™„ë£Œ - Web3Forms ì—°ë™');
}

// ê³ ê°ë²ˆí˜¸ ì°¾ê¸° ë²„íŠ¼ ê¸°ëŠ¥
function openCustomerSearchPopup() {
    const url = 'https://www.patent.go.kr/smart/jsp/kiponet/mp/mpopenpatinfo/apagtinfo/ReadApAgtInfoInput.do';
    const popupOptions = 'width=1000,height=800,scrollbars=yes,resizable=yes,status=yes,menubar=no,toolbar=no,location=no';

    // íŒì—…ì°½ ì—´ê¸°
    const popup = window.open(url, 'customerSearch', popupOptions);

    // íŒì—…ì°½ì´ ë¸”ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (!popup || popup.closed || typeof popup.closed === 'undefined') {
        alert('íŒì—… ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì €ì˜ íŒì—… ì°¨ë‹¨ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\në˜ëŠ” ë‹¤ìŒ ë§í¬ë¥¼ ì§ì ‘ ì—´ì–´ì£¼ì„¸ìš”:\n' + url);
        return;
    }

    // íŒì—…ì°½ ì¤‘ì•™ ì •ë ¬
    if (popup.moveTo) {
        const left = (screen.width - 1000) / 2;
        const top = (screen.height - 800) / 2;
        popup.moveTo(left, top);
    }

    // íŒì—…ì°½ í¬ì»¤ìŠ¤
    popup.focus();
}

// Event listeners setup (avoiding CSP issues with inline onclick)
document.addEventListener('DOMContentLoaded', function() {
    // PCT ë‚©ë¶€ì˜ë¢° ë²„íŠ¼
    const pctRequestBtn = document.getElementById('pctRequestBtn');
    if (pctRequestBtn) {
        pctRequestBtn.addEventListener('click', requestPCTFiling);
    }

    // Export button
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.addEventListener('click', exportToExcel);
    }

    // ê³ ê°ë²ˆí˜¸ ì°¾ê¸° ë²„íŠ¼
    const findCustomerBtn = document.getElementById('findCustomerBtn');
    if (findCustomerBtn) {
        findCustomerBtn.addEventListener('click', openCustomerSearchPopup);
    }
});
</script>