<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title><%= title %> - ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ íŠ¹í—ˆ í˜„í™© ì¡°íšŒ ì‹œìŠ¤í…œ">
    <meta name="keywords" content="íŠ¹í—ˆ, íŠ¹í—ˆì‚¬ë¬´ì†Œ, íŠ¹í—ˆ í˜„í™©, ë“±ë¡íŠ¹í—ˆ, ì¶œì›íŠ¹í—ˆ, ìœ ë‹ˆí¬">
    <meta name="author" content="ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="<%= title %> - ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ">
    <meta property="og:description" content="ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ íŠ¹í—ˆ í˜„í™© ì¡°íšŒ ì‹œìŠ¤í…œ">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://unicpat.com">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/images/favicon.svg">
    <link rel="alternate icon" href="/images/favicon.svg">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">
                    ìœ ë‹ˆí¬<span>íŠ¹í—ˆ</span>
                </a>
                <nav class="nav-tabs">
                    <a href="/registered" class="nav-link">ë“±ë¡íŠ¹í—ˆ í˜„í™©</a>
                    <a href="/application" class="nav-link">ì¶œì›íŠ¹í—ˆ í˜„í™©</a>
                </nav>
            </div>
        </div>
    </header>

<main class="main-content">
    <div class="container">
        <div class="page-title">
            <h1>ë“±ë¡íŠ¹í—ˆ í˜„í™©</h1>
            <p>ê³ ê°ë²ˆí˜¸ë¡œ ë“±ë¡ëœ íŠ¹í—ˆ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤</p>
        </div>

        <!-- ê²€ìƒ‰ ì„¹ì…˜ -->
        <section class="search-section">
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <!-- ê²€ìƒ‰ ìœ í˜• ì„ íƒ -->
                    <div class="search-type-group" style="margin-bottom: 1rem;">
                        <label class="form-label">ê²€ìƒ‰ ìœ í˜•</label>
                        <div class="radio-group" style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                            <label class="radio-option" style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="searchType" value="1" id="businessNumberType" style="margin-right: 0.5rem;">
                                <span>ì‚¬ì—…ìë²ˆí˜¸ (10ìë¦¬)</span>
                            </label>
                            <label class="radio-option" style="display: flex; align-items: center; cursor: pointer;">
                                <input type="radio" name="searchType" value="2" id="customerNumberType" checked style="margin-right: 0.5rem;">
                                <span>ê³ ê°ë²ˆí˜¸ (12ìë¦¬)</span>
                            </label>
                        </div>
                    </div>

                    <!-- ê²€ìƒ‰ ì…ë ¥ -->
                    <label for="searchInput" class="form-label" id="searchInputLabel">ê³ ê°ë²ˆí˜¸</label>
                    <div class="input-group">
                        <input
                            type="text"
                            id="searchInput"
                            name="searchInput"
                            class="form-input customer-number-input"
                            placeholder="ì˜ˆ: 120190612244"
                            maxlength="12"
                            pattern="[0-9]{12}"
                            required
                        >
                        <button type="submit" class="btn btn-primary" id="searchBtn">
                            ğŸ” ê²€ìƒ‰í•˜ê¸°
                        </button>
                    </div>
                    <div class="form-hint" id="searchInputHint">12ìë¦¬ ìˆ«ì ì…ë ¥í•˜ì„¸ìš”</div>
                </div>
                <button type="button" class="btn btn-warning service-application-btn" id="serviceApplicationBtn">
                    ì„œë¹„ìŠ¤ì´ìš© ì‹ ì²­
                </button>
                <button type="button" class="btn btn-secondary find-customer-btn" id="findCustomerBtn">
                    ê³ ê°ë²ˆí˜¸ ì°¾ê¸°
                </button>
            </form>
        </section>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <section class="results-section" id="resultsSection" style="display: none;">
            <div class="results-header">
                <div class="results-info">
                    <div class="info-item">
                        <span class="info-label">ì¡°íšŒì¼ì:</span>
                        <span class="info-value" id="resultCurrentDate">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">ê¶Œë¦¬ì:</span>
                        <span class="info-value" id="resultRightHolderName">-</span>
                    </div>
                                    
                    <div class="info-item">
                        <span class="info-label">ê±´ìˆ˜:</span>
                        <span class="info-value" id="resultTotalCount">0</span>ê±´
                    </div>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-info" id="calculateAnnuityBtn">
                        ğŸ§® ì—°ì°¨ë£Œ ê³„ì‚°
                    </button>
                    <button type="button" class="btn btn-primary" id="renewalRequestBtn">
                        ğŸ’° ë‚©ë¶€ì˜ë¢°
                    </button>
                    <button type="button" class="btn btn-secondary" id="exportBtn">
                        ğŸ“Š ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="patent-table" id="patentTable">
                    <thead>
                        <tr>
                            <th>ì¶œì›ë²ˆí˜¸</th>
                            <th>ë“±ë¡ë²ˆí˜¸</th>
                            <th>ì¶œì›ì¸</th>
                            <th>ì¶œì›ì¼</th>
                            <th>ë“±ë¡ì¼</th>
                            <th>ì¡´ì†ê¸°ê°„ ë§Œë£Œì¼</th>
                            <th>ë°œëª…ì˜ëª…ì¹­</th>
                            <th>ì²­êµ¬í•­ìˆ˜</th>
                            <th>ë“±ë¡ìƒíƒœ</th>
                            <th>ì§ì „ë…„ë„ ë‚©ë¶€ì—°ì›”</th>
                            <th>í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼</th>
                            <th>í•´ë‹¹ì—°ì°¨ìˆ˜</th>
                            <th>í•´ë‹¹ì—°ì°¨ë£Œ</th>
                            <th>ë¯¸ë‚©ì—¬ë¶€</th>
                            <th>ì¶”ë‚©ê¸°ê°„ ë§ˆê°</th>
                            <th>íšŒë³µê¸°ê°„ ë§ˆê°</th>
                        </tr>
                    </thead>
                    <tbody id="patentTableBody">
                        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-icon">ğŸ“„</div>
                <div class="empty-title">ë“±ë¡íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="empty-description">í•´ë‹¹ ê³ ê°ë²ˆí˜¸ë¡œ ë“±ë¡ëœ íŠ¹í—ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </section>
    </div>
</main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-text">
                    <strong>ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ</strong> - íŠ¹í—ˆ í˜„í™© ì¡°íšŒ ì‹œìŠ¤í…œ
                </div>
                <div class="footer-contact">
                    <a href="tel:010-3131-7960">ğŸ“ 010-3131-7960</a>
                    <a href="mailto:ljunhyek@naver.com">âœ‰ï¸ ljunhyek@naver.com</a>
                    <a href="https://unicpat.com" target="_blank">ğŸŒ unicpat.com</a>
                </div>
                <div class="footer-text" style="margin-top: 1rem; font-size: 0.875rem; color: #94a3b8;">
                    Â© 2024 ìœ ë‹ˆí¬ íŠ¹í—ˆì‚¬ë¬´ì†Œ. All rights reserved.
                </div>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="/js/main.js"></script>
</body>
</html>

<script>
// ìºì‹œ ë¬´íš¨í™”ë¥¼ ìœ„í•œ ë²„ì „ ì²´í¬
console.log('ğŸ”„ ë‚©ë¶€ì˜ë¢° ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨ - ë²„ì „: 2025.08.21.v2');
</script>

<!-- ë“±ë¡íŠ¹í—ˆ ê²€ìƒ‰ ê¸°ëŠ¥ ë° ì—°ì°¨ë£Œ ê³„ì‚° ê¸°ëŠ¥ -->
<script src="/js/registered.js?v=2025.09.19.v12"></script>

<script>
// ê¸°ì¡´ ì—°ì°¨ë£Œ ê³„ì‚° ê´€ë ¨ ìƒìˆ˜ë“¤ê³¼ í•¨ìˆ˜ë“¤ì€ ì™¸ë¶€ íŒŒì¼ë¡œ ì´ë™
// ì´ ì„¹ì…˜ì€ ì¶”ê°€ ê¸°ëŠ¥ì„ ìœ„í•œ ê³µê°„ìœ¼ë¡œ ì‚¬ìš©

// ì—°ì°¨ë£Œ ê³„ì‚° ì •ì±… (annuity.txtì—ì„œ ê°€ì ¸ì˜¨ ì •ì±…)
const ANNUITY_POLICY = {
    "name": "KIPO-default",
    "currency": "KRW",
    "grace_months": 6,
    "recovery_months": 3,
    "late_fee_table": {
        "1": 0.03,
        "2": 0.06,
        "3": 0.09,
        "4": 0.12,
        "5": 0.15,
        "6": 0.18
    },
    "recovery_policy": { "type": "multiplier", "value": 2.0 },
    "rounding": "nearest_10",
    "reminder_rules": [
        { "months_before_due": 6, "label": "ì‚¬ì „ì˜ˆê³ -6ê°œì›”" },
        { "months_before_due": 3, "label": "ì‚¬ì „ì˜ˆê³ -3ê°œì›”" },
        { "months_before_due": 1, "label": "ì‚¬ì „ì˜ˆê³ -1ê°œì›”" }
    ]
};

// ìƒˆë¡œìš´ ì—°ì°¨ë£Œ ê¸°ë³¸ë£Œ í…Œì´ë¸” (ìµœì‹  ê¸°ì¤€)
const NEW_BASE_FEES = {
    1: 13000,   2: 13000,   3: 13000,        // 1~3ë…„ì°¨: 13,000ì›
    4: 36000,   5: 36000,   6: 36000,        // 4~6ë…„ì°¨: 36,000ì›
    7: 90000,   8: 90000,   9: 90000,        // 7~9ë…„ì°¨: 90,000ì›
    10: 216000, 11: 216000, 12: 216000,      // 10~12ë…„ì°¨: 216,000ì›
    13: 324000, 14: 324000, 15: 324000,      // 13~25ë…„ì°¨: 324,000ì›
    16: 324000, 17: 324000, 18: 324000,
    19: 324000, 20: 324000, 21: 324000, 22: 324000, 23: 324000, 24: 324000, 25: 324000
};

// ìƒˆë¡œìš´ ì²­êµ¬í•­ ê°€ì‚°ë£Œ í…Œì´ë¸” (ì²­êµ¬ë²”ìœ„ 1í•­ë§ˆë‹¤)
const NEW_CLAIM_FEES = {
    1: 12000,   2: 12000,   3: 12000,        // 1~3ë…„ì°¨: 12,000ì›
    4: 20000,   5: 20000,   6: 20000,        // 4~6ë…„ì°¨: 20,000ì›
    7: 34000,   8: 34000,   9: 34000,        // 7~9ë…„ì°¨: 34,000ì›
    10: 49000,  11: 49000,  12: 49000,       // 10~12ë…„ì°¨: 49,000ì›
    13: 49000,  14: 49000,  15: 49000,       // 13~25ë…„ì°¨: 49,000ì›
    16: 49000,  17: 49000,  18: 49000,
    19: 49000,  20: 49000,  21: 49000, 22: 49000, 23: 49000, 24: 49000, 25: 49000
};

// ì—°ì°¨ë£Œ ê³„ì‚° í—¬í¼ í•¨ìˆ˜ë“¤ (ê°„ì†Œí™”)

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (main.jsì˜ í•¨ìˆ˜ë“¤ì„ ë¡œì»¬ì—ì„œ ì‚¬ìš©)
function showError(message) {
    alert(message); // ê°„ë‹¨í•œ alertë¡œ ëŒ€ì²´
}

function hideError() {
    // ë¡œì»¬ êµ¬í˜„ - í•„ìš”ì‹œ í™•ì¥
}

function formatDate(dateStr) {
    if (!dateStr || dateStr === '-') return '-';
    return dateStr;
}

// ìƒˆë¡œìš´ ì—°ì°¨ë£Œ ê³„ì‚°ì— ë”°ë¥¸ ê°ë©´ ìœ í˜• ì •ì˜
const NEW_DISCOUNT_TYPES = {
    'type1': { 
        name: 'ê°œì¸/ì¤‘ì†Œê¸°ì—…/ê³µê³µì—°êµ¬ê¸°ê´€/ì „ë‹´ì¡°ì§/ì§€ë°©ìì¹˜ë‹¨ì²´', 
        rate: 0.5,  // 50% ê°ë©´ (4ë…„ì°¨ë¶€í„° ì¡´ì†ê¸°ê°„ê¹Œì§€)
        description: 'ê°œì¸, ì¤‘ì†Œê¸°ì—…, ê³µê³µì—°êµ¬ê¸°ê´€, ì „ë‹´ì¡°ì§, ì§€ë°©ìì¹˜ë‹¨ì²´ ë“±ì´ í•´ë‹¹ë©ë‹ˆë‹¤.',
        applicableFromYear: 4
    },
    'type1_1': { 
        name: 'ì¤‘ì†Œê¸°ì—… + ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—…/ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…', 
        rate: 0.7,  // 4~9ë…„ì°¨ 70% ê°ë©´, 10ë…„ì°¨ë¶€í„° 50% ê°ë©´
        rate10Plus: 0.5,  // 10ë…„ì°¨ë¶€í„°ëŠ” 50% ê°ë©´
        description: 'ì¤‘ì†Œê¸°ì—…ì´ë©´ì„œ ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—… ë˜ëŠ” ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…ì…ë‹ˆë‹¤.',
        applicableFromYear: 4
    },
    'type2': { 
        name: 'ì¤‘ê²¬ê¸°ì—…', 
        rate: 0.3,  // 30% ê°ë©´ (4~9ë…„ì°¨)
        description: 'ì¤‘ê²¬ê¸°ì—…ì…ë‹ˆë‹¤.',
        applicableFromYear: 4,
        applicableToYear: 9
    },
    'type2_1': { 
        name: 'ì¤‘ê²¬ê¸°ì—… + ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—…/ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…', 
        rate: 0.5,  // 50% ê°ë©´ (4~9ë…„ì°¨)
        description: 'ì¤‘ê²¬ê¸°ì—…ì´ë©´ì„œ ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—… ë˜ëŠ” ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…ì…ë‹ˆë‹¤.',
        applicableFromYear: 4,
        applicableToYear: 9
    },
    'none': {
        name: 'í•´ë‹¹ì‚¬í•­ ì—†ìŒ',
        rate: 0,
        description: 'ê°ë©´ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤.',
        applicableFromYear: 1
    }
};

// ê°ë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
function showDiscountSelectionModal() {
    // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
    const existingModal = document.getElementById('discountModal');
    if (existingModal) {
        existingModal.remove();
    }

    const modalHTML = `
        <div id="discountModal" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
            <div class="modal-content" style="background: white; border-radius: 12px; padding: 2rem; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px rgba(0,0,0,0.15);">
                <div class="modal-header" style="border-bottom: 2px solid #54B435; padding-bottom: 1rem; margin-bottom: 1.5rem;">
                    <h2 style="color: #0F172A; font-size: 1.5rem; font-weight: 700; margin: 0; text-align: center;">ğŸ§® ì—°ì°¨ë£Œ ê³„ì‚°</h2>
                    <p style="color: #64748B; font-size: 0.95rem; margin: 0.5rem 0 0 0; text-align: center;">ê°ë©´ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
                </div>
                
                <div class="discount-selection" style="margin-bottom: 2rem;">
                    <h3 style="color: #374151; font-size: 1.1rem; font-weight: 600; margin: 0 0 1rem 0;">ì•„ë˜ í•´ë‹¹í•  ê²½ìš° ì²´í¬í‘œì‹œí•˜ì„¸ìš”</h3>
                    
                    <div class="discount-options" style="space-y: 0.75rem;">
                        <label class="discount-option" style="display: flex; align-items: flex-start; padding: 1rem; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="discountType" value="type1" style="margin: 0.25rem 1rem 0 0; width: 18px; height: 18px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">ê°œì¸/ì¤‘ì†Œê¸°ì—…/ê³µê³µì—°êµ¬ê¸°ê´€/ì „ë‹´ì¡°ì§/ì§€ë°©ìì¹˜ë‹¨ì²´</div>
                                <div style="font-size: 0.9rem; color: #6B7280;">4ë…„ì°¨ë¶€í„° ì¡´ì†ê¸°ê°„ê¹Œì§€ 50% ê°ë©´</div>
                            </div>
                        </label>
                        
                        <label class="discount-option" style="display: flex; align-items: flex-start; padding: 1rem; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="discountType" value="type1_1" style="margin: 0.25rem 1rem 0 0; width: 18px; height: 18px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">ì¤‘ì†Œê¸°ì—… + ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—…/ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…</div>
                                <div style="font-size: 0.9rem; color: #6B7280;">4~9ë…„ì°¨ 70% ê°ë©´, 10ë…„ì°¨ë¶€í„° ì¡´ì†ê¸°ê°„ê¹Œì§€ 50% ê°ë©´</div>
                            </div>
                        </label>
                        
                        <label class="discount-option" style="display: flex; align-items: flex-start; padding: 1rem; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="discountType" value="type2" style="margin: 0.25rem 1rem 0 0; width: 18px; height: 18px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">ì¤‘ê²¬ê¸°ì—…</div>
                                <div style="font-size: 0.9rem; color: #6B7280;">4~9ë…„ì°¨ 30% ê°ë©´</div>
                            </div>
                        </label>
                        
                        <label class="discount-option" style="display: flex; align-items: flex-start; padding: 1rem; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="discountType" value="type2_1" style="margin: 0.25rem 1rem 0 0; width: 18px; height: 18px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">ì¤‘ê²¬ê¸°ì—… + ì§ë¬´ë°œëª…ë³´ìƒìš°ìˆ˜ê¸°ì—…/ì§€ì‹ì¬ì‚°ê²½ì˜ì¸ì¦ê¸°ì—…</div>
                                <div style="font-size: 0.9rem; color: #6B7280;">4~9ë…„ì°¨ 50% ê°ë©´</div>
                            </div>
                        </label>
                        
                        <label class="discount-option" style="display: flex; align-items: flex-start; padding: 1rem; border: 2px solid #E5E7EB; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="discountType" value="none" style="margin: 0.25rem 1rem 0 0; width: 18px; height: 18px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151; margin-bottom: 0.25rem;">í•´ë‹¹ì‚¬í•­ ì—†ìŒ</div>
                                <div style="font-size: 0.9rem; color: #6B7280;">ê°ë©´ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" id="discountCancelBtn" style="padding: 0.75rem 1.5rem; border: 1px solid #D1D5DB; background: white; color: #374151; border-radius: 6px; cursor: pointer; font-weight: 500;">ì·¨ì†Œ</button>
                    <button type="button" id="discountCalculateBtn" style="padding: 0.75rem 1.5rem; background: #54B435; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">ê³„ì‚°í•˜ê¸°</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ ì‹œ ìŠ¤íƒ€ì¼ ë³€ê²½
    const radioButtons = document.querySelectorAll('input[name="discountType"]');
    radioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            const options = document.querySelectorAll('.discount-option');
            options.forEach(option => {
                option.style.borderColor = '#E5E7EB';
                option.style.backgroundColor = 'white';
            });
            
            if (this.checked) {
                const selectedOption = this.closest('.discount-option');
                selectedOption.style.borderColor = '#54B435';
                selectedOption.style.backgroundColor = '#F0FDF4';
            }
        });
    });

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('discountModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDiscountModal();
        }
    });
    
    // ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.getElementById('discountCancelBtn').addEventListener('click', closeDiscountModal);
    document.getElementById('discountCalculateBtn').addEventListener('click', calculateWithSelectedDiscount);
}

// ê°ë©´ ëª¨ë‹¬ ë‹«ê¸°
function closeDiscountModal() {
    const modal = document.getElementById('discountModal');
    if (modal) {
        modal.remove();
    }
}

// ì„ íƒëœ ê°ë©´ ìœ í˜•ìœ¼ë¡œ ì—°ì°¨ë£Œ ê³„ì‚°
function calculateWithSelectedDiscount() {
    console.log('ğŸ”¢ calculateWithSelectedDiscount() í•¨ìˆ˜ ì‹¤í–‰');
    
    const selectedRadio = document.querySelector('input[name="discountType"]:checked');
    if (!selectedRadio) {
        alert('ê°ë©´ ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const discountType = selectedRadio.value;
    console.log('ğŸ“ ì„ íƒëœ ê°ë©´ ìœ í˜•:', discountType);
    
    closeDiscountModal();
    
    // ìƒˆë¡œìš´ ê³„ì‚° ë°©ì‹ìœ¼ë¡œ ì—°ì°¨ë£Œ ê³„ì‚° ì‹¤í–‰
    console.log('âš¡ performNewAnnuityCalculation() í˜¸ì¶œ');
    performNewAnnuityCalculation(discountType);
}

// ì—°ì°¨ë£Œ ê³„ì‚° ë©”ì¸ í•¨ìˆ˜ (ê°ë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ)
function calculateAnnuityFees() {
    // ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ì˜ currentPatents ë³€ìˆ˜ ì‚¬ìš©
    if (!window.currentPatents || window.currentPatents.length === 0) {
        showError('ê³„ì‚°í•  íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ê°ë©´ ìœ í˜• ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
    showDiscountSelectionModal();
}

// ìƒˆë¡œìš´ ì—°ì°¨ë£Œ ê³„ì‚° ë¡œì§
function performNewAnnuityCalculation(discountType) {
    console.log('ğŸ§® performNewAnnuityCalculation() ì‹œì‘, discountType:', discountType);
    console.log('ğŸ“Š window.currentPatents:', window.currentPatents);

    if (!window.currentPatents || window.currentPatents.length === 0) {
        console.error('âŒ íŠ¹í—ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
        showError('ê³„ì‚°í•  íŠ¹í—ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    console.log('âœ… íŠ¹í—ˆ ë°ì´í„° í™•ì¸ë¨, ê³„ì‚° ì‹œì‘');

    const today = new Date();

    // ëª¨ë“  íŠ¹í—ˆ ë°ì´í„° ì²˜ë¦¬ (í˜ì´ì§€ë„¤ì´ì…˜ê³¼ ê´€ê³„ì—†ì´)
    for (let actualIndex = 0; actualIndex < window.currentPatents.length; actualIndex++) {
        const patent = window.currentPatents[actualIndex];

        // í˜„ì¬ í˜ì´ì§€ì—ì„œ í•´ë‹¹ íŠ¹í—ˆì˜ í–‰ì„ ì°¾ê¸°
        const currentPageStartIndex = ((window.currentPage || 1) - 1) * (window.itemsPerPage || 10);
        const currentPageEndIndex = currentPageStartIndex + (window.itemsPerPage || 10);
        const isInCurrentPage = actualIndex >= currentPageStartIndex && actualIndex < currentPageEndIndex;

        let cells = null;
        if (isInCurrentPage) {
            const tableBody = document.getElementById('patentTableBody');
            const rows = tableBody.getElementsByTagName('tr');
            const rowIndex = actualIndex - currentPageStartIndex;
            if (rowIndex < rows.length) {
                cells = rows[rowIndex].getElementsByTagName('td');
            }
        }

        // ë“±ë¡ìƒíƒœê°€ 'ë“±ë¡ìœ ì§€'ì¸ ê²½ìš°ì—ë§Œ ì—°ì°¨ë£Œ ê³„ì‚°
        if (patent.registrationStatus !== 'ë“±ë¡ìœ ì§€') {
            console.log('âš ï¸ íŠ¹í—ˆ ' + actualIndex + ' ë“±ë¡ìƒíƒœê°€ ë“±ë¡ìœ ì§€ê°€ ì•„ë‹˜:', patent.registrationStatus);

            // ë“±ë¡ìœ ì§€ê°€ ì•„ë‹Œ ê²½ìš° 'í•´ë‹¹ì—†ìŒ' í‘œì‹œ
            patent.calculatedData = {
                previousPaymentMonth: patent.paymentHistory ?
                    (patent.paymentHistory.payDate && patent.paymentHistory.payDate !== '-' ?
                        window.formatPaymentDate(patent.paymentHistory.payDate) +
                        ' (' + patent.paymentHistory.lastAnnl + 'ë…„ì°¨ / ' +
                        window.formatPaymentAmount(patent.paymentHistory.payAmount) + ')' :
                        '-') : '-',
                dueDate: 'í•´ë‹¹ì—†ìŒ',
                annualYear: 'í•´ë‹¹ì—†ìŒ',
                annualFee: 'í•´ë‹¹ì—†ìŒ',
                validityStatus: 'í•´ë‹¹ì—†ìŒ',
                latePaymentPeriod: 'í•´ë‹¹ì—†ìŒ',
                recoveryPeriod: 'í•´ë‹¹ì—†ìŒ'
            };

            // í˜„ì¬ í˜ì´ì§€ì— í‘œì‹œë˜ëŠ” ê²½ìš°ë§Œ UI ì—…ë°ì´íŠ¸
            if (cells) {
                // ì§ì „ë…„ë„ ë‚©ë¶€ì •ë³´ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ (cells[9]ë¥¼ ìœ ì§€)
                // cells[9].textContentëŠ” ì´ë¯¸ fetchPaymentHistoryì—ì„œ ì„¤ì •ë˜ì—ˆìœ¼ë¯€ë¡œ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
                cells[10].textContent = 'í•´ë‹¹ì—†ìŒ'; // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
                cells[11].textContent = 'í•´ë‹¹ì—†ìŒ'; // í•´ë‹¹ì—°ì°¨ìˆ˜
                cells[12].textContent = 'í•´ë‹¹ì—†ìŒ'; // í•´ë‹¹ì—°ì°¨ë£Œ
                cells[13].textContent = 'í•´ë‹¹ì—†ìŒ'; // ìœ íš¨/ë¶ˆë‚©
                cells[14].textContent = 'í•´ë‹¹ì—†ìŒ'; // ì¶”ë‚©ê¸°ê°„
                cells[15].textContent = 'í•´ë‹¹ì—†ìŒ'; // íšŒë³µê¸°ê°„
            }
            continue;
        }

        // ë“±ë¡ì¼ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ê³„ì‚°
        if (patent.registrationDate && patent.registrationDate !== '-') {
            const registrationDate = new Date(patent.registrationDate);
            
            // 3ë…„ ì—…í”„ë¡ íŠ¸ ë‚©ë¶€ ê·œì¹™ ì ìš©: ë“±ë¡ì¼ ê¸°ì¤€ 3ë…„ í›„ë¶€í„° ì—°ì°¨ë£Œ ë‚©ë¶€ ì‹œì‘
            const threeYearsAfterRegistration = new Date(registrationDate);
            threeYearsAfterRegistration.setFullYear(threeYearsAfterRegistration.getFullYear() + 3);
            
            // í˜„ì¬ ë‚ ì§œê°€ ë“±ë¡ì¼ + 3ë…„ì´ ì•„ì§ ì•ˆ ëœ ê²½ìš° ì²˜ë¦¬
            let isBeforeFirstPaymentDue = today < threeYearsAfterRegistration;
            
            if (isBeforeFirstPaymentDue) {
                // í˜„ì¬ ë‚ ì§œ < ë“±ë¡ì¼ + 3ë…„ì¸ ê²½ìš°:
                // - í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼: ë“±ë¡ì¼ + 3ë…„
                // - í•´ë‹¹ì—°ì°¨ìˆ˜: 4ë…„ì°¨
                // - ì§ì „ë…„ë„ ë‚©ë¶€ì—°ì›”: ë¹ˆì¹¸
                // - ì¶”ë‚©ê¸°ê°„, íšŒë³µê¸°ê°„: í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼ ê¸°ì¤€ ê³„ì‚°
                
                // 4ë…„ì°¨ ì—°ì°¨ë£Œ ê³„ì‚°
                const fourthYearCalculation = calculateNewAnnuityFee(4, patent.claimCount || 1, discountType, "ì •ìƒë‚©ë¶€", null, null);

                // ë‚©ë¶€ ë§ˆê°ì¼ ê³„ì‚°
                const dueDateStr = (parseInt(patent.registrationDate.substring(0, 4)) + 3) + patent.registrationDate.substring(4);
                const dueDate = new Date(dueDateStr.substring(0, 4) + '-' + dueDateStr.substring(5, 7) + '-' + dueDateStr.substring(8, 10));

                // ì¶”ë‚©ê¸°ê°„ê³¼ íšŒë³µê¸°ê°„ ê³„ì‚°
                let latePaymentPeriod = '-';
                let recoveryPeriod = '-';

                // í˜„ì¬ ë‚ ì§œê°€ ë‚©ë¶€ ë§ˆê°ì¼ì„ ì§€ë‚œ ê²½ìš°ì—ë§Œ ê³„ì‚°
                if (today > dueDate) {
                    // ì¶”ë‚©ê¸°ê°„: ë‚©ë¶€ ë§ˆê°ì¼ + 6ê°œì›”
                    const latePaymentEnd = new Date(dueDate);
                    latePaymentEnd.setMonth(latePaymentEnd.getMonth() + 6);

                    // íšŒë³µê¸°ê°„: ë‚©ë¶€ ë§ˆê°ì¼ + 9ê°œì›” (ì¶”ë‚©ê¸°ê°„ + 3ê°œì›”)
                    const recoveryEnd = new Date(dueDate);
                    recoveryEnd.setMonth(recoveryEnd.getMonth() + 9);

                    // ì¶”ë‚©ê¸°ê°„ê³¼ íšŒë³µê¸°ê°„ ë§ˆê°ì¼ ëª¨ë‘ í‘œì‹œ
                    latePaymentPeriod = latePaymentEnd.getFullYear() + '.' +
                                       String(latePaymentEnd.getMonth() + 1).padStart(2, '0') + '.' +
                                       String(latePaymentEnd.getDate()).padStart(2, '0');

                    recoveryPeriod = recoveryEnd.getFullYear() + '.' +
                                   String(recoveryEnd.getMonth() + 1).padStart(2, '0') + '.' +
                                   String(recoveryEnd.getDate()).padStart(2, '0');
                }

                // ê³„ì‚°ëœ ë°ì´í„°ë¥¼ íŠ¹í—ˆ ê°ì²´ì— ì €ì¥
                patent.calculatedData = {
                    previousPaymentMonth: patent.paymentHistory ?
                        (patent.paymentHistory.payDate && patent.paymentHistory.payDate !== '-' ?
                            window.formatPaymentDate(patent.paymentHistory.payDate) +
                            ' (' + patent.paymentHistory.lastAnnl + 'ë…„ì°¨ / ' +
                            window.formatPaymentAmount(patent.paymentHistory.payAmount) + ')' :
                            '-') : '-',
                    dueDate: dueDateStr, // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
                    annualYear: '4ë…„ì°¨',
                    annualFee: fourthYearCalculation.totalFee.toLocaleString() + 'ì›',
                    validityStatus: 'ì •ìƒë‚©ë¶€',
                    latePaymentPeriod: latePaymentPeriod,
                    recoveryPeriod: recoveryPeriod
                };

                console.log('ğŸ’¾ íŠ¹í—ˆ ' + actualIndex + ' ê³„ì‚° ë°ì´í„° ì €ì¥ ì™„ë£Œ (ë“±ë¡ì¼+3ë…„ ì´ì „):', {
                    applicationNumber: patent.applicationNumber,
                    registrationDate: patent.registrationDate,
                    fourthYearDueDate: '9999.99.99',
                    annualYear: '4ë…„ì°¨',
                    annualFee: fourthYearCalculation.totalFee.toLocaleString() + 'ì›',
                    isInCurrentPage: isInCurrentPage
                });

                // í˜„ì¬ í˜ì´ì§€ì— í‘œì‹œë˜ëŠ” ê²½ìš° UI ì—…ë°ì´íŠ¸
                if (cells) {
                    // ì§ì „ë…„ë„ ë‚©ë¶€ì •ë³´ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ (cells[9]ë¥¼ ìœ ì§€)
                    // cells[9].textContentëŠ” ì´ë¯¸ fetchPaymentHistoryì—ì„œ ì„¤ì •ë˜ì—ˆìœ¼ë¯€ë¡œ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
                    cells[10].textContent = patent.calculatedData.dueDate; // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
                    cells[11].textContent = patent.calculatedData.annualYear; // í•´ë‹¹ì—°ì°¨ìˆ˜
                    cells[12].textContent = patent.calculatedData.annualFee; // í•´ë‹¹ì—°ì°¨ë£Œ

                    // ë¯¸ë‚©ì—¬ë¶€ ìƒíƒœ í‘œì‹œ
                    if (patent.calculatedData.validityStatus === 'ì •ìƒë‚©ë¶€') {
                        cells[13].textContent = '-';
                        cells[13].className = '';
                    } else {
                        cells[13].textContent = patent.calculatedData.validityStatus;
                        cells[13].className = '';
                    }

                    // ì¶”ë‚©ê¸°ê°„ ë§ˆê°ì¼ (ë¹¨ê°„ìƒ‰ í‘œì‹œ)
                    cells[14].textContent = patent.calculatedData.latePaymentPeriod;
                    if (patent.calculatedData.latePaymentPeriod !== '-') {
                        cells[14].className = 'deadline-danger';
                    } else {
                        cells[14].className = '';
                    }

                    // íšŒë³µê¸°ê°„ ë§ˆê°ì¼ (ë¹¨ê°„ìƒ‰ í‘œì‹œ)
                    cells[15].textContent = patent.calculatedData.recoveryPeriod;
                    if (patent.calculatedData.recoveryPeriod !== '-') {
                        cells[15].className = 'deadline-danger';
                    } else {
                        cells[15].className = '';
                    }
                }
                continue;
            }
            
            // í˜„ì¬ ì—°ì°¨ìˆ˜ ê³„ì‚° (4ë…„ì°¨ë¶€í„° ì‹œì‘)
            const annualYear = Math.floor((today.getTime() - threeYearsAfterRegistration.getTime()) / (365.25 * 24 * 60 * 60 * 1000)) + 4;
            
            // ë‹¤ìŒ ì—°ì°¨ìˆ˜ ê³„ì‚° (1ë…„ ì•ì„œì„œ ë‚©ë¶€í•˜ëŠ” ê°œë…)
            let nextYear = annualYear + 1;

            // ë¯¸ë‚© ìƒíƒœ í™•ì¸ ë¡œì§ ì¶”ê°€
            let isUnpaid = false;
            let adjustedNextYear = nextYear;

            // ë‚©ë¶€ ì´ë ¥ì´ ìˆëŠ” ê²½ìš° ë¯¸ë‚© ì—¬ë¶€ í™•ì¸
            if (patent.paymentHistory && patent.paymentHistory.lastAnnl && patent.paymentHistory.lastAnnl !== '-') {
                const lastPaidYear = parseInt(patent.paymentHistory.lastAnnl);

                // í•´ë‹¹ì—°ì°¨ìˆ˜ - ì§ì „ë…„ë„ ì—°ì°¨ìˆ˜ = 2 ì´ë©´ ë¯¸ë‚© ìƒíƒœ
                if (nextYear - lastPaidYear === 2) {
                    isUnpaid = true;
                    adjustedNextYear = nextYear - 1; // í•´ë‹¹ì—°ì°¨ìˆ˜ ì¡°ì •
                    console.log('âš ï¸ ë¯¸ë‚© ê°ì§€:', {
                        applicationNumber: patent.applicationNumber,
                        ì›ë˜í•´ë‹¹ì—°ì°¨ìˆ˜: nextYear,
                        ì§ì „ë…„ë„ì—°ì°¨ìˆ˜: lastPaidYear,
                        ì¡°ì •ëœí•´ë‹¹ì—°ì°¨ìˆ˜: adjustedNextYear
                    });
                }
            }

            // ì¡°ì •ëœ ì—°ì°¨ìˆ˜ë¡œ ì—…ë°ì´íŠ¸
            nextYear = adjustedNextYear;

            // ì—°ì°¨ìˆ˜ê°€ 25ë…„ì„ ì´ˆê³¼í•˜ë©´ íŠ¹í—ˆ ë§Œë£Œ
            if (nextYear > 25) {
                patent.calculatedData = {
                    previousPaymentMonth: patent.paymentHistory ?
                        (patent.paymentHistory.payDate && patent.paymentHistory.payDate !== '-' ?
                            window.formatPaymentDate(patent.paymentHistory.payDate) +
                            ' (' + patent.paymentHistory.lastAnnl + 'ë…„ì°¨ / ' +
                            window.formatPaymentAmount(patent.paymentHistory.payAmount) + ')' :
                            '-') : '-',
                    dueDate: '-',
                    annualYear: 'ë§Œë£Œ',
                    annualFee: '-',
                    validityStatus: 'ë§Œë£Œ',
                    latePaymentPeriod: '-',
                    recoveryPeriod: '-'
                };

                if (cells) {
                    // ì§ì „ë…„ë„ ë‚©ë¶€ì •ë³´ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ (cells[9]ë¥¼ ìœ ì§€)
                    cells[10].textContent = '-'; // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
                    cells[11].textContent = 'ë§Œë£Œ'; // í•´ë‹¹ì—°ì°¨ìˆ˜
                    cells[12].textContent = '-'; // í•´ë‹¹ì—°ì°¨ë£Œ
                    cells[13].textContent = 'ë§Œë£Œ'; // ìœ íš¨/ë¶ˆë‚©
                    cells[14].textContent = '-'; // ì¶”ë‚©ê¸°ê°„
                    cells[15].textContent = '-'; // íšŒë³µê¸°ê°„
                }
                continue;
            }
            
            // ë‹¤ìŒ ì—°ì°¨ ì •ë³´ ê³„ì‚° (í•´ë‹¹ì—°ì°¨ìˆ˜/í•´ë‹¹ì—°ì°¨ë£Œì— í‘œì‹œí•  ì •ë³´)
            const nextCalculation = calculateNewAnnuityFee(nextYear, patent.claimCount || 1, discountType, "ì •ìƒë‚©ë¶€", null, null);

            // ì„ì‹œê°’ ì„¤ì •
            const nextStatus = "ì •ìƒë‚©ë¶€";

            // ë‚©ë¶€ ë§ˆê°ì¼ ê³„ì‚°
            const dueDateStr = (parseInt(patent.registrationDate.substring(0, 4)) + nextYear - 1) + patent.registrationDate.substring(4);
            const dueDate = new Date(dueDateStr.substring(0, 4) + '-' + dueDateStr.substring(5, 7) + '-' + dueDateStr.substring(8, 10));

            // ì¶”ë‚©ê¸°ê°„ê³¼ íšŒë³µê¸°ê°„ ê³„ì‚° - í•­ìƒ ë§ˆê°ì¼ í‘œì‹œ
            let latePaymentPeriod = '-';
            let recoveryPeriod = '-';

            // ì¶”ë‚©ê¸°ê°„: ë‚©ë¶€ ë§ˆê°ì¼ + 6ê°œì›”
            const latePaymentEnd = new Date(dueDate);
            latePaymentEnd.setMonth(latePaymentEnd.getMonth() + 6);

            // íšŒë³µê¸°ê°„: ë‚©ë¶€ ë§ˆê°ì¼ + 9ê°œì›” (ì¶”ë‚©ê¸°ê°„ + 3ê°œì›”)
            const recoveryEnd = new Date(dueDate);
            recoveryEnd.setMonth(recoveryEnd.getMonth() + 9);

            // ì¶”ë‚©ê¸°ê°„ ë§ˆê°ì¼ í‘œì‹œ (ë‚©ë¶€ ë§ˆê°ì¼ì´ ì§€ë‚œ ê²½ìš° í•­ìƒ í‘œì‹œ)
            if (today > dueDate) {
                latePaymentPeriod = latePaymentEnd.getFullYear() + '.' +
                                   String(latePaymentEnd.getMonth() + 1).padStart(2, '0') + '.' +
                                   String(latePaymentEnd.getDate()).padStart(2, '0');

                recoveryPeriod = recoveryEnd.getFullYear() + '.' +
                               String(recoveryEnd.getMonth() + 1).padStart(2, '0') + '.' +
                               String(recoveryEnd.getDate()).padStart(2, '0');
            }

            // ì •ìƒë‚©ë¶€/ë¯¸ë‚© ìƒíƒœ ê²°ì •
            let paymentStatus = isUnpaid ? "ë¯¸ë‚©" : "ì •ìƒë‚©ë¶€";

            // ê³„ì‚°ëœ ë°ì´í„°ë¥¼ íŠ¹í—ˆ ê°ì²´ì— ì €ì¥
            patent.calculatedData = {
                previousPaymentMonth: patent.paymentHistory ?
                    (patent.paymentHistory.payDate && patent.paymentHistory.payDate !== '-' ?
                        window.formatPaymentDate(patent.paymentHistory.payDate) +
                        ' (' + patent.paymentHistory.lastAnnl + 'ë…„ì°¨ / ' +
                        window.formatPaymentAmount(patent.paymentHistory.payAmount) + ')' :
                        '-') : '-',
                dueDate: dueDateStr,  // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
                annualYear: nextYear + 'ë…„ì°¨',
                annualFee: nextCalculation.totalFee.toLocaleString() + 'ì›',
                validityStatus: paymentStatus,  // ë¯¸ë‚© ë˜ëŠ” ìœ íš¨ ìƒíƒœ
                latePaymentPeriod: latePaymentPeriod,
                recoveryPeriod: recoveryPeriod
            };
            
            console.log('ğŸ’¾ íŠ¹í—ˆ ' + actualIndex + ' ê³„ì‚° ë°ì´í„° ì €ì¥ ì™„ë£Œ:', {
                applicationNumber: patent.applicationNumber,
                annualYear: patent.calculatedData.annualYear,
                annualFee: patent.calculatedData.annualFee,
                validityStatus: patent.calculatedData.validityStatus,
                isInCurrentPage: isInCurrentPage
            });
            
            // í˜„ì¬ í˜ì´ì§€ì— í‘œì‹œë˜ëŠ” ê²½ìš°ë§Œ UI ì—…ë°ì´íŠ¸
            if (cells) {
                // ì§ì „ë…„ë„ ë‚©ë¶€ì •ë³´ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ (cells[9]ë¥¼ ìœ ì§€)
                // cells[9].textContentëŠ” ì´ë¯¸ fetchPaymentHistoryì—ì„œ ì„¤ì •ë˜ì—ˆìœ¼ë¯€ë¡œ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ
                cells[10].textContent = patent.calculatedData.dueDate; // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
                cells[11].textContent = patent.calculatedData.annualYear; // í•´ë‹¹ì—°ì°¨ìˆ˜
                cells[12].textContent = patent.calculatedData.annualFee; // í•´ë‹¹ì—°ì°¨ë£Œ

                // ë¯¸ë‚©ì—¬ë¶€ ìƒíƒœ í‘œì‹œ (ë¯¸ë‚©ì¼ ê²½ìš° ë¹¨ê°„ìƒ‰)
                if (patent.calculatedData.validityStatus === 'ë¯¸ë‚©') {
                    cells[13].textContent = 'ë¯¸ë‚©';
                    cells[13].className = 'text-danger';
                } else if (patent.calculatedData.validityStatus === 'ì •ìƒë‚©ë¶€') {
                    cells[13].textContent = '-';
                    cells[13].className = '';
                } else {
                    cells[13].textContent = patent.calculatedData.validityStatus;
                    cells[13].className = '';
                }

                // ì¶”ë‚©ê¸°ê°„ ë§ˆê°ì¼ (ë¹¨ê°„ìƒ‰ í‘œì‹œ)
                cells[14].textContent = patent.calculatedData.latePaymentPeriod;
                if (patent.calculatedData.latePaymentPeriod !== '-') {
                    cells[14].className = 'deadline-danger';
                } else {
                    cells[14].className = '';
                }

                // íšŒë³µê¸°ê°„ ë§ˆê°ì¼ (ë¹¨ê°„ìƒ‰ í‘œì‹œ)
                cells[15].textContent = patent.calculatedData.recoveryPeriod;
                if (patent.calculatedData.recoveryPeriod !== '-') {
                    cells[15].className = 'deadline-danger';
                } else {
                    cells[15].className = '';
                }
            }
        } else {
            // ë“±ë¡ì¼ì´ ì—†ëŠ” ê²½ìš°
            patent.calculatedData = {
                previousPaymentMonth: patent.paymentHistory ?
                    (patent.paymentHistory.payDate && patent.paymentHistory.payDate !== '-' ?
                        window.formatPaymentDate(patent.paymentHistory.payDate) +
                        ' (' + patent.paymentHistory.lastAnnl + 'ë…„ì°¨ / ' +
                        window.formatPaymentAmount(patent.paymentHistory.payAmount) + ')' :
                        '-') : '-',
                dueDate: '-',
                annualYear: '-',
                annualFee: '-',
                validityStatus: '-',
                latePaymentPeriod: '-',
                recoveryPeriod: '-'
            };

            if (cells) {
                // ì§ì „ë…„ë„ ë‚©ë¶€ì •ë³´ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ (cells[9]ë¥¼ ìœ ì§€)
                cells[10].textContent = '-'; // í•´ë‹¹ ì—°ì°¨ë£Œ ë‚©ë¶€ë§ˆê°ì¼
                cells[11].textContent = '-'; // í•´ë‹¹ì—°ì°¨ìˆ˜
                cells[12].textContent = '-'; // í•´ë‹¹ì—°ì°¨ë£Œ
                cells[13].textContent = '-'; // ìœ íš¨/ë¶ˆë‚©
                cells[14].textContent = '-'; // ì¶”ë‚©ê¸°ê°„
                cells[15].textContent = '-'; // íšŒë³µê¸°ê°„
            }
        }
    }
    
    // ë””ë²„ê·¸: ê³„ì‚° ì™„ë£Œ í›„ ì „ì²´ ë°ì´í„° ê²€ì¦
    console.log('ğŸ” ê³„ì‚° ì™„ë£Œ í›„ ì „ì²´ ë°ì´í„° ê²€ì¦:');
    console.log('   window.currentPatents.length:', window.currentPatents.length);
    if (window.currentPatents) {
        let calculatedCount = 0;
        window.currentPatents.forEach((patent, index) => {
            const hasCalculatedData = patent.calculatedData && patent.calculatedData.annualYear !== '-';
            if (hasCalculatedData) calculatedCount++;
            console.log('   íŠ¹í—ˆ ' + index + ': ' + patent.applicationNumber + ' â†’ ê³„ì‚°ë°ì´í„°: ' + (hasCalculatedData ? patent.calculatedData.annualYear : 'NO DATA'));
        });
        console.log('   âœ… ê³„ì‚°ëœ íŠ¹í—ˆ ìˆ˜: ' + calculatedCount + '/' + window.currentPatents.length);
        
        // í˜„ì¬ í˜ì´ì§€ ì •ë³´ë„ ì¶œë ¥
        console.log('   í˜„ì¬ í˜ì´ì§€:', window.currentPage || 1);
        console.log('   í˜ì´ì§€ë‹¹ í•­ëª© ìˆ˜:', window.itemsPerPage || 10);
    }
    
    // ê³„ì‚° ì™„ë£Œ ë©”ì‹œì§€ (ê°ë©´ ìœ í˜• í¬í•¨)
    const discountInfo = NEW_DISCOUNT_TYPES[discountType];
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.innerHTML = `
        <div style="font-weight: 600; margin-bottom: 0.5rem;">âœ… ì—°ì°¨ë£Œ ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>
        <div style="font-size: 0.9rem; opacity: 0.9;">ì ìš©ëœ ê°ë©´: ${discountInfo.name}</div>
    `;
    successDiv.style.cssText = 'background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; text-align: center;';
    
    const resultsSection = document.getElementById('resultsSection');
    const existingSuccess = document.querySelector('.success-message');
    if (existingSuccess) {
        existingSuccess.remove();
    }
    resultsSection.insertBefore(successDiv, resultsSection.firstChild);
    
    // 5ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
    setTimeout(() => {
        if (successDiv.parentNode) {
            successDiv.remove();
        }
    }, 5000);
}

// ìƒˆë¡œìš´ ì—°ì°¨ë£Œ ê³„ì‚° í•¨ìˆ˜ (ê°„ì†Œí™”)
function calculateNewAnnuityFee(annualYear, claimCount, discountType, status) {
    // 1. ê¸°ë³¸ë£Œ ê³„ì‚°
    const baseFee = NEW_BASE_FEES[annualYear] || NEW_BASE_FEES[25];
    
    // 2. ì²­êµ¬í•­ ê°€ì‚°ë£Œ ê³„ì‚°
    const claimFeePerItem = NEW_CLAIM_FEES[annualYear] || NEW_CLAIM_FEES[25];
    const claims = Math.max(1, parseInt(claimCount) || 1);
    const claimSurchargeFee = claimFeePerItem * claims;
    
    // 3. ì •ìƒ ì—°ì°¨ë£Œ = ê¸°ë³¸ë£Œ + ì²­êµ¬í•­ ê°€ì‚°ë£Œ
    const normalFee = baseFee + claimSurchargeFee;
    
    // 4. ê°ë©´ìœ¨ ì ìš©
    let discountRate = 0;
    const discount = NEW_DISCOUNT_TYPES[discountType];
    
    if (discount && annualYear >= discount.applicableFromYear) {
        // ê°ë©´ ì ìš© ê°€ëŠ¥í•œ ì—°ì°¨ì¸ì§€ í™•ì¸
        const isApplicable = !discount.applicableToYear || annualYear <= discount.applicableToYear;
        
        if (isApplicable) {
            // ìœ í˜•1-1ì˜ ê²½ìš° 10ë…„ì°¨ ì´í›„ ê°ë©´ìœ¨ ë³€ê²½
            if (discountType === 'type1_1' && annualYear >= 10) {
                discountRate = discount.rate10Plus;
            } else {
                discountRate = discount.rate;
            }
        }
    }
    
    // 5. ê°ë©´ ì—°ì°¨ë£Œ ê³„ì‚°
    const discountedFee = Math.round(normalFee * (1 - discountRate));
    
    // 6. ì¶”ê°€ ë¹„ìš©ì€ ì¼ë‹¨ 0ìœ¼ë¡œ ì„¤ì •
    let additionalFee = 0;
    let finalFee = discountedFee;
    
    return {
        baseFee: baseFee,
        claimSurchargeFee: claimSurchargeFee,
        normalFee: normalFee,
        discountRate: discountRate,
        discountedFee: discountedFee,
        additionalFee: additionalFee,
        totalFee: finalFee,
        status: status
    };
}

// ì—°ì°¨ë£Œ ë‚©ë¶€ì˜ë¢° ê´€ë ¨ í•¨ìˆ˜ë“¤ì€ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ (registered.js)ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.

// ê³ ê°ë²ˆí˜¸ ì°¾ê¸° ë²„íŠ¼ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
    const findCustomerBtn = document.getElementById('findCustomerBtn');

    if (findCustomerBtn) {
        findCustomerBtn.addEventListener('click', function() {
            openCustomerSearchPopup();
        });
    }

    // ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­ ë²„íŠ¼ ê¸°ëŠ¥
    const serviceApplicationBtn = document.getElementById('serviceApplicationBtn');

    if (serviceApplicationBtn) {
        serviceApplicationBtn.addEventListener('click', function() {
            showServiceApplicationModal();
        });
    }
});

function openCustomerSearchPopup() {
    const url = 'https://www.patent.go.kr/smart/jsp/kiponet/mp/mpopenpatinfo/apagtinfo/ReadApAgtInfoInput.do';
    const popupOptions = 'width=1000,height=800,scrollbars=yes,resizable=yes,status=yes,menubar=no,toolbar=no,location=no';
    
    // íŒì—…ì°½ ì—´ê¸°
    const popup = window.open(url, 'customerSearch', popupOptions);
    
    // íŒì—…ì°½ì´ ë¸”ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸
    if (!popup || popup.closed || typeof popup.closed === 'undefined') {
        alert('íŒì—… ì°½ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì €ì˜ íŒì—… ì°¨ë‹¨ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\në˜ëŠ” ë‹¤ìŒ ë§í¬ë¥¼ ì§ì ‘ ì—´ì–´ì£¼ì„¸ìš”:\n' + url);
        return;
    }
    
    // íŒì—…ì°½ ì¤‘ì•™ ì •ë ¬
    if (popup.moveTo) {
        const left = (screen.width - 1000) / 2;
        const top = (screen.height - 800) / 2;
        popup.moveTo(left, top);
    }
    
    // íŒì—…ì°½ í¬ì»¤ìŠ¤
    popup.focus();
}

// ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­ ëª¨ë‹¬ í‘œì‹œ
function showServiceApplicationModal() {
    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë“±ë¡
    window.closeServiceApplicationModal = function() {
        const modal = document.getElementById('serviceApplicationModal');
        if (modal) {
            modal.remove();
        }
    };

    // ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­ ì•ˆë‚´ë¬¸
    const serviceApplicationGuidanceText = `
        <h3 style="color: #0F172A; font-size: 1.2rem; font-weight: 600; margin: 0 0 1rem 0;">ì„œë¹„ìŠ¤ ì´ìš© ì‹ ì²­</h3>
        <div style="line-height: 1.6; color: #374151; margin-bottom: 1.5rem;">
            <p style="margin: 0 0 0.5rem 0; font-weight: 600;">ì‹¤ì‹œê°„ ë“±ë¡íŠ¹í—ˆ í˜„í™© ë° ì¶œì›íŠ¹í—ˆ í˜„í™© ì„œë¹„ìŠ¤ ì´ìš©ì„ ì‹ ì²­í•©ë‹ˆë‹¤</p>
        </div>
    `;

    // ëª¨ë‹¬ HTML ìƒì„±
    const modalHTML = `
        <div id="serviceApplicationModal" class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;">
            <div class="modal-content" style="background: white; border-radius: 8px; padding: 2rem; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.15);">
                <div class="modal-header" style="border-bottom: 2px solid #F59E0B; padding-bottom: 1rem; margin-bottom: 1.5rem;">
                    <h2 style="color: #0F172A; font-size: 1.5rem; font-weight: 700; margin: 0; text-align: center;">ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­</h2>
                </div>

                <div class="guidance-text" style="background: #fef3c7; padding: 1.5rem; border-radius: 6px; margin-bottom: 1.5rem; border-left: 4px solid #F59E0B;">
                    ${serviceApplicationGuidanceText}
                </div>

                <form id="serviceApplicationForm">
                    <input type="hidden" name="access_key" value="dd3c9ad5-1802-4bd1-b7e6-397002308afa">
                    <input type="hidden" name="subject" value="ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­">

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem;">ì‚¬ì—…ìë²ˆí˜¸ <span style="color: #ef4444;">*</span></label>
                        <input type="text" name="business_number" id="business_number" required
                               pattern="[0-9]{10}" maxlength="10"
                               style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px;"
                               placeholder="10ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem;">íŠ¹í—ˆ ê³ ê°ë²ˆí˜¸ <span style="color: #ef4444;">*</span></label>
                        <input type="text" name="customer_number" id="customer_number_service" required
                               pattern="[0-9]{12}" maxlength="12"
                               style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px;"
                               placeholder="12ìë¦¬ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem;">ì´ë¦„ <span style="color: #ef4444;">*</span></label>
                        <input type="text" name="name" id="name_service" required
                               style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px;"
                               placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem;">ì´ë©”ì¼ <span style="color: #ef4444;">*</span></label>
                        <input type="email" name="email" id="email_service" required
                               style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px;"
                               placeholder="example@email.com">
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; color: #374151; font-weight: 500; margin-bottom: 0.5rem;">ì—°ë½ì²˜ <span style="color: #ef4444;">*</span></label>
                        <input type="tel" name="phone" id="phone_service" required
                               style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 4px;"
                               placeholder="010-0000-0000">
                    </div>

                    <textarea name="message" style="display: none;">ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­

ì‚¬ì—…ìë²ˆí˜¸: [ì‚¬ì—…ìë²ˆí˜¸]
íŠ¹í—ˆ ê³ ê°ë²ˆí˜¸: [ê³ ê°ë²ˆí˜¸]
ì´ë¦„: [ì´ë¦„]
ì´ë©”ì¼: [ì´ë©”ì¼]
ì—°ë½ì²˜: [ì—°ë½ì²˜]

ìˆ˜ì‹ ì: ljunhyek@naver.com
ì œëª©: ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­</textarea>
                    <input type="hidden" name="to" value="ljunhyek@naver.com">

                    <div style="margin-bottom: 1.5rem; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb; padding: 1rem; font-size: 0.9rem; color: #6b7280; line-height: 1.5;">
                        <p style="margin: 0 0 0.5rem 0;"><strong>ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜</strong></p>
                        <p style="margin: 0 0 0.5rem 0;">ìˆ˜ì§‘Â·ì´ìš© ëª©ì : ë“±ë¡íŠ¹í—ˆ í˜„í™© ë° ì¶œì›íŠ¹í—ˆ í˜„í™© ì„œë¹„ìŠ¤</p>
                        <p style="margin: 0 0 0.5rem 0;">ìˆ˜ì§‘ í•­ëª©: ì‚¬ì—…ìë²ˆí˜¸, íŠ¹í—ˆ ê³ ê°ë²ˆí˜¸, ì´ë¦„, ì—°ë½ì²˜, ì´ë©”ì¼</p>
                        <p style="margin: 0 0 0.75rem 0;">ë³´ìœ  ë° ì´ìš© ê¸°ê°„: ì„œë¹„ìŠ¤ ì´ìš© ì‹ ì²­ í•´ì œì‹œ</p>
                        <label style="display: flex; align-items: center; color: #374151; font-size: 0.9rem;">
                            <input type="checkbox" name="privacy_consent" id="privacy_consent_service" required style="margin-right: 0.5rem; width: 16px; height: 16px;">
                            ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤.
                        </label>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button type="button" onclick="closeServiceApplicationModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 4px; cursor: pointer; font-weight: 500;">ì·¨ì†Œ</button>
                        <button type="submit" style="padding: 0.75rem 1.5rem; background: #F59E0B; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­</button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬
    const form = document.getElementById('serviceApplicationForm');
    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;

            try {
                // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
                submitBtn.textContent = 'ì „ì†¡ ì¤‘...';
                submitBtn.disabled = true;

                // FormData ìƒì„±
                const formData = new FormData(form);

                // Web3Formsì— ì „ì†¡
                const response = await fetch('https://api.web3forms.com/submit', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    console.log('âœ… ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­ ì „ì†¡ ì™„ë£Œ');
                    // ì„±ê³µ ì‹œ s_thanks í˜ì´ì§€ë¡œ ì´ë™
                    window.location.href = '/s_thanks';
                } else {
                    throw new Error('ì „ì†¡ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('âŒ ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­ ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('ì‹ ì²­ì„œ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');

                // ë²„íŠ¼ ë³µì›
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });
    }

    console.log('âœ… ì„œë¹„ìŠ¤ ì´ìš©ì‹ ì²­ ëª¨ë‹¬ ìƒì„± ì™„ë£Œ - JavaScript ì œì¶œ ë°©ì‹');
}
</script>